<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Absensi & Keterlambatan - Refactored</title> <!-- Title updated -->

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Font Awesome for Icons (Optional, for Theme Toggle) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <!-- SweetAlert2 CSS & JS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- TAMBAHKAN CDN: Firebase SDK v8.10.0 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <!-- Tambahkan SDK Firebase lain jika dibutuhkan (misal, auth, storage) -->


  <style>
    /* ... (CSS Anda tetap sama, dengan tambahan untuk sub-nav) ... */
     /* ========== RESET & GLOBAL STYLES ========== */
     :root {
        /* Default Light Theme Colors */
        --bg-color: #f0f2f5;
        --text-color: #333;
        --card-bg-color: #fff;
        --header-bg-color: #4a90e2;
        --header-text-color: #fff;
        --nav-bg-color: #fff;
        --nav-item-bg-color: #e0e6ed;
        --nav-item-text-color: #333;
        --nav-item-active-bg-color: #4a90e2;
        --nav-item-active-text-color: #fff;
        --input-bg-color: #fff;
        --input-border-color: #ccc;
        --table-header-bg-color: #4a90e2;
        --table-header-text-color: #fff;
        --table-row-even-bg-color: #f9f9f9;
        --table-row-hover-bg-color: #eef4f9;
        --link-color: #333; /* Default link color */
        --link-hover-color: #000;
        --modal-bg-color: #fff;
        --box-shadow-color: rgba(0,0,0,0.1);
        --primary-color: #4a90e2;
        --secondary-color: #95a5a6;
        --danger-color: #e74c3c;
        --success-color: #2ecc71;
        --warning-color: #f39c12;
        --info-color: #3498db;
    }

    [data-theme="dark"] {
        --bg-color: #1a1a1a;
        --text-color: #e0e0e0;
        --card-bg-color: #2c2c2c;
        --header-bg-color: #357ABD; /* Slightly darker blue */
        --header-text-color: #f0f0f0;
        --nav-bg-color: #252525;
        --nav-item-bg-color: #404040;
        --nav-item-text-color: #e0e0e0;
        --nav-item-active-bg-color: #357ABD;
        --nav-item-active-text-color: #fff;
        --input-bg-color: #333;
        --input-border-color: #555;
        --table-header-bg-color: #357ABD;
        --table-header-text-color: #f0f0f0;
        --table-row-even-bg-color: #303030;
        --table-row-hover-bg-color: #454545;
        --link-color: #e0e0e0;
        --link-hover-color: #fff;
        --modal-bg-color: #2c2c2c;
        --box-shadow-color: rgba(255,255,255,0.1);
        --primary-color: #357ABD;
        --secondary-color: #7f8c8d;
        --danger-color: #c0392b;
        --success-color: #27ae60;
        --warning-color: #e67e22;
        --info-color: #2980b9;
    }


    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    html {
        scroll-behavior: smooth;
    }
    body {
      font-family: "Segoe UI", Tahoma, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
       transition: background-color 0.3s ease, color 0.3s ease; /* Transition for theme change */
    }
    a {
      text-decoration: none;
      color: var(--link-color);
    }
    a:hover {
        color: var(--link-hover-color);
    }
    button, .swal2-actions a.btn {
      cursor: pointer;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-size: 1rem;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      position: relative; /* For potential loading indicators */
      color: #fff; /* Default button text color - ensure contrast */
      margin: 0 5px;
    }
     button.btn-secondary, button.btn-warning { color: #fff; } /* Ensure contrast for these too */
     [data-theme="dark"] button { color: #fff; } /* Ensure contrast in dark mode */
     [data-theme="dark"] button.btn-secondary { color: #fff; }
     [data-theme="dark"] button.btn-warning { color: #333; } /* Warning text dark on dark */


    button:hover, .swal2-actions a.btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px var(--box-shadow-color);
    }
    button:disabled, .swal2-actions a.btn.disabled {
        cursor: not-allowed;
        background-color: #ccc !important;
        transform: none;
        box-shadow: none;
         color: #666 !important; /* Disabled text color */
         pointer-events: none;
    }
    button .spinner {
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-block-start: 2px solid #fff;
        border-radius: 50%;
        inline-size: 1em;
        block-size: 1em;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-inline-start: 8px;
        vertical-align: middle;
    }

    /* ========== HEADER STYLES ========== */
    header {
      background-color: var(--header-bg-color);
      color: var(--header-text-color);
      padding: 20px 0;
      text-align: center;
      box-shadow: 0 2px 4px var(--box-shadow-color);
      display: flex; /* For Theme Toggle */
      justify-content: center; /* Center title */
      align-items: center;
      position: relative; /* For positioning toggle */
    }
    header h1 {
      font-size: 2rem;
      margin: 0;
      flex-grow: 1; /* Allow title to take space */
      text-align: center; /* Ensure centered */
      /* Adjust padding if toggle button pushes title */
      padding: 0 50px; /* Add padding to sides */
    }
     /* NEW FEATURE: Theme Toggle Button */
    #themeToggle {
      position: absolute;
      inset-inline-end: 20px; /* Position on the right */
      font-size: 1.2rem;
      background: none;
      border: none;
      color: var(--header-text-color);
      cursor: pointer;
      padding: 5px;
    }

    /* ========== NAVBAR STYLES ========== */
    nav {
      background-color: var(--nav-bg-color);
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      padding: 10px 0;
      box-shadow: 0 2px 4px var(--box-shadow-color);
      position: sticky;
      inset-block-start: 0;
      z-index: 100;
    }
    nav .nav-item {
      margin: 5px 10px;
      padding: 10px 15px;
      background-color: var(--nav-item-bg-color);
      color: var(--nav-item-text-color);
      border-radius: 20px;
      transition: background-color 0.3s ease, color 0.3s ease;
      border: 1px solid transparent;
    }
    nav .nav-item:hover {
      background-color: #d1d9e1; /* Keep hover distinct or use variables */
      color: #000;
      [data-theme="dark"] & { /* Dark mode hover */
         background-color: #555;
         color: #fff;
      }
    }
    nav .nav-item.active {
      background-color: var(--nav-item-active-bg-color);
      color: var(--nav-item-active-text-color);
      font-weight: bold;
      border-color: #357ABD;
       [data-theme="dark"] & { border-color: #4a90e2; }
    }

    /* ========== SUB-NAVIGATION (TABS) STYLES - NEW ========== */
    .sub-nav {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        border-bottom: 2px solid var(--input-border-color);
        margin-bottom: 25px;
        padding-bottom: 10px;
    }
    .sub-nav-item {
        padding: 8px 16px;
        background-color: var(--nav-item-bg-color);
        color: var(--nav-item-text-color);
        border-radius: 8px;
        font-weight: 500;
        border: 1px solid transparent;
    }
    .sub-nav-item:hover {
        background-color: #d1d9e1;
        color: #000;
        transform: none; /* Override default button hover */
        box-shadow: none;
        [data-theme="dark"] & {
            background-color: #555;
            color: #fff;
        }
    }
    .sub-nav-item.active {
        background-color: var(--primary-color);
        color: var(--header-text-color);
        border-color: var(--primary-color);
    }


    /* ========== CONTAINER & SCREEN STYLES ========== */
    .container {
      max-inline-size: 1200px;
      margin: 30px auto;
      padding: 25px;
      background-color: var(--card-bg-color);
      border-radius: 10px;
      box-shadow: 0 4px 12px var(--box-shadow-color);
    }
    .screen, .sub-screen {
      display: none;
      animation: fadeIn 0.5s ease;
    }
    .screen.active, .sub-screen.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    h2 {
        color: var(--text-color); /* Use variable */
        margin-block-end: 25px;
        border-block-end: 2px solid var(--primary-color); /* Use variable */
        padding-block-end: 10px;
    }
    h3 {
        color: var(--text-color); /* Use variable */
        margin-block-start: 20px;
        margin-block-end: 15px;
    }

    /* ========== FORM & INPUT STYLES ========== */
    label {
      display: block;
      margin: 15px 0 5px;
      font-weight: 600;
      color: var(--text-color); /* Use variable */
    }
    input[type="text"],
    input[type="date"],
    input[type="time"], /* Added for Time Input */
    input[type="month"],
    input[type="search"],
    input[type="number"], /* Added for Range Filter */
    select,
    input[type="file"] {
      inline-size: 100%;
      padding: 12px;
      border: 1px solid var(--input-border-color);
      border-radius: 5px;
      font-size: 1rem;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
      background-color: var(--input-bg-color);
      color: var(--text-color); /* Ensure text is readable */
    }
    input[type="text"]:focus,
    input[type="date"]:focus,
    input[type="time"]:focus,
    input[type="month"]:focus,
    input[type="search"]:focus,
    input[type="number"]:focus,
    select:focus,
    input[type="file"]:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
       [data-theme="dark"] & { box-shadow: 0 0 0 3px rgba(53, 122, 189, 0.3); }
    }
     /* Make datalist options visible in dark mode */
     [data-theme="dark"] option {
         background-color: var(--input-bg-color);
         color: var(--text-color);
     }
     [data-theme="dark"] select option {
         background: var(--input-bg-color); /* For select dropdowns */
         color: var(--text-color);
     }

    .radio-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-block-end: 15px;
    }
    .radio-item {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .input-group {
        margin-block-end: 20px;
    }
    .form-actions {
        margin-block-start: 25px;
    }
    .filter-section {
        background-color: var(--nav-item-bg-color); /* Use theme variable */
        padding: 15px;
        border-radius: 8px;
        margin-block-end: 25px;
        border: 1px solid var(--input-border-color); /* Use theme variable */
    }
     .filter-section h3 {
        margin-block-start: 0;
        margin-block-end: 15px;
     }
    .filter-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: flex-end;
    }
    .filter-controls > div {
        flex: 1 1 180px; /* Adjust base width */
    }
     .filter-controls label {
        margin-block-start: 0;
     }
     .filter-controls input[type="number"] {
        inline-size: calc(50% - 8px); /* For range inputs */
     }
    .search-bar {
        margin-block-end: 15px;
    }
    .search-bar input[type="search"] {
        max-inline-size: 400px;
        display: inline-block;
    }

    /* ========== BUTTON STYLES ========== */
    .btn { margin-inline-end: 8px; margin-block-end: 8px;}
    .btn-primary { background-color: var(--primary-color); color: #fff; }
    .btn-primary:hover { background-color: #357ABD; [data-theme="dark"] & { background-color: #4a90e2; } }
    .btn-danger { background-color: var(--danger-color); color: #fff; }
    .btn-danger:hover { background-color: #c0392b; [data-theme="dark"] & { background-color: #e74c3c; } }
    .btn-secondary { background-color: var(--secondary-color); color: #fff; }
    .btn-secondary:hover { background-color: #7f8c8d; [data-theme="dark"] & { background-color: #95a5a6; } }
    .btn-warning { background-color: var(--warning-color); color: #fff; [data-theme="dark"] & { color: #333; } }
    .btn-warning:hover { background-color: #e67e22; [data-theme="dark"] & { background-color: #f39c12; } }
    .btn-success { background-color: var(--success-color); color: #fff; }
    .btn-success:hover { background-color: #27ae60; [data-theme="dark"] & { background-color: #2ecc71; } }


    /* ========== TABLE STYLES ========== */
    .table-container {
        overflow-x: auto;
    }
    table {
      inline-size: 100%;
      border-collapse: collapse;
      margin-block-start: 20px;
      background-color: var(--card-bg-color);
      box-shadow: 0 2px 4px var(--box-shadow-color);
    }
    th, td {
      padding: 12px 15px;
      text-align: start;
      border-block-end: 1px solid var(--input-border-color); /* Use theme variable */
      vertical-align: middle;
    }
    th {
      background-color: var(--table-header-bg-color);
      color: var(--table-header-text-color);
      font-weight: 600;
      white-space: nowrap;
    }
    th.sortable {
        cursor: pointer;
        position: relative;
        padding-inline-end: 25px;
    }
    th.sortable:hover {
        background-color: #357ABD;
        [data-theme="dark"] & { background-color: #4a90e2; }
    }
    th .sort-icon {
        position: absolute;
        inset-inline-end: 8px;
        inset-block-start: 50%;
        transform: translateY(-50%);
        font-size: 0.8em;
        color: var(--table-header-text-color);
    }
    tr:nth-child(even) {
      background-color: var(--table-row-even-bg-color);
    }
    tr:hover {
      background-color: var(--table-row-hover-bg-color);
    }
    td button {
        margin-inline-end: 5px;
        padding: 5px 10px;
        font-size: 0.9rem;
    }
    /* NEW FEATURE: Clickable Row/Name for Detail View */
    .clickable-name {
        cursor: pointer;
        color: var(--primary-color);
        text-decoration: underline;
    }
    .clickable-name:hover {
        color: var(--info-color);
    }


    /* ========== STATUS BOX / FILTER RESULT STYLES ========== */
    .status-box {
      margin: 15px 0;
      padding: 15px;
      border-radius: 5px;
      font-weight: 500;
      border: 1px solid;
    }
    .status-box.info { background-color: #eaf2f8; border-color: #aed6f1; color: #2e86c1; [data-theme="dark"] & { background-color: #2c3e50; border-color: #3498db; color: #ecf0f1;} }
    .status-box.success { background-color: #dff0d8; border-color: #d0e9c6; color: #3c763d; [data-theme="dark"] & { background-color: #27ae60; border-color: #2ecc71; color: #fff;} }
    .status-box.warning { background-color: #fcf8e3; border-color: #faebcc; color: #8a6d3b; [data-theme="dark"] & { background-color: #f39c12; border-color: #e67e22; color: #333;} }
    .status-box.error { background-color: #f2dede; border-color: #ebccd1; color: #a94442; [data-theme="dark"] & { background-color: #c0392b; border-color: #e74c3c; color: #fff;} }


    /* ========== DASHBOARD STYLES ========== */
    .dashboard-section {
      margin-block-end: 40px;
    }
    .dashboard-card {
      padding: 25px;
      background-color: var(--card-bg-color);
      border-radius: 10px;
      box-shadow: 0 4px 12px var(--box-shadow-color);
      border-block-start: 4px solid var(--primary-color);
    }
    .dashboard-card h3 {
      margin-block-start: 0;
      margin-block-end: 20px;
      color: var(--text-color);
      font-size: 1.3rem;
    }

    /* ========== MODAL STYLES ========== */
    .modal {
      display: none;
      position: fixed;
      z-index: 200;
      inset-inline-start: 0;
      inset-block-start: 0;
      inline-size: 100%;
      block-size: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7); /* Darker overlay */
      align-items: start; /* Align modal to top */
      justify-content: center;
      padding: 40px 20px 20px 20px; /* Add padding top */
    }
    .modal-content {
      background-color: var(--modal-bg-color);
      padding: 30px;
      border-radius: 10px;
      inline-size: 90%;
      max-inline-size: 700px; /* Increase max-width for detail modal */
      position: relative;
      box-shadow: 0 5px 20px rgba(0,0,0,0.4);
      animation: slideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      margin-bottom: 40px; /* Add margin bottom for scroll */
    }
    @keyframes slideIn {
      from { transform: translateY(-30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .modal-content h3 {
        margin-block-start: 0;
        color: var(--text-color);
    }
    .close {
      position: absolute;
      inset-block-start: 15px;
      inset-inline-end: 20px;
      font-size: 1.8rem;
      font-weight: bold;
      color: #aaa;
      cursor: pointer;
      transition: color 0.3s ease;
      line-height: 1;
    }
    .close:hover {
      color: var(--text-color);
    }
    .modal-actions {
        margin-block-start: 25px;
        text-align: end;
    }
    .modal-actions button {
        margin-inline-start: 10px;
    }
     /* NEW FEATURE: Siswa Detail Modal Specific Styles */
     #siswaDetailModalContent .siswa-info {
         display: grid;
         grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
         gap: 10px 20px;
         margin-bottom: 25px;
         padding-bottom: 15px;
         border-bottom: 1px solid var(--input-border-color);
     }
      #siswaDetailModalContent .siswa-info p { margin: 5px 0; }
      #siswaDetailModalContent .siswa-info strong { color: var(--primary-color); }
      #siswaDetailHistoryTableContainer { max-height: 300px; overflow-y: auto; }


    /* ========== FOOTER STYLES ========== */
    footer {
      background-color: var(--nav-bg-color); /* Use theme variable */
      padding: 25px 0;
      text-align: center;
      box-shadow: 0 -2px 8px var(--box-shadow-color);
      margin-block-start: 50px;
    }
    .footer-line {
      inline-size: 60px;
      block-size: 4px;
      background-color: var(--primary-color);
      margin: 0 auto 15px auto;
      border-radius: 2px;
    }
    footer p {
      color: var(--secondary-color); /* Use theme variable */
      font-size: 0.9rem;
      line-height: 1.5;
    }

    /* ========== NOTIFICATION STYLES ========== */
    #notification-area {
        position: fixed;
        inset-block-start: 80px;
        inset-inline-end: 20px;
        z-index: 1050;
        inline-size: 300px;
        max-inline-size: 90%;
    }
    .toast {
        background-color: #333;
        color: #fff;
        padding: 15px;
        margin-block-end: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        opacity: 0;
        transition: opacity 0.5s ease, transform 0.5s ease;
        transform: translateX(100%);
    }
    .toast.show {
        opacity: 1;
        transform: translateX(0);
    }
    /* Use theme variables for toast backgrounds */
    .toast.toast-success { background-color: var(--success-color); color: #fff; }
    .toast.toast-error { background-color: var(--danger-color); color: #fff; }
    .toast.toast-info { background-color: var(--info-color); color: #fff; }
    .toast.toast-warning { background-color: var(--warning-color); color: #333; }


    /* ========== LOADER STYLES ========== */
    .loader-container {
        text-align: center;
        padding: 40px;
    }
    .loader {
      border: 6px solid #f3f3f3;
       [data-theme="dark"] & { border-color: #444; }
      border-block-start: 6px solid var(--primary-color);
      border-radius: 50%;
      inline-size: 50px;
      block-size: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
      display: inline-block;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* ========== NEW FEATURE: Bulk Input Styles ========== */
    #bulkAbsensiSiswaList {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--input-border-color);
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
    }
    #bulkAbsensiSiswaList label {
        display: block; /* Each student on a new line */
        margin-bottom: 5px;
    }

     /* ========== NEW FEATURE: Help Screen Styles ========== */
     #bantuanScreen .help-section {
         margin-bottom: 30px;
         padding: 20px;
         background-color: var(--nav-item-bg-color); /* Use theme color */
         border-radius: 8px;
         border: 1px solid var(--input-border-color);
     }
     #bantuanScreen .help-section h3 {
         margin-top: 0;
         border-bottom: 1px solid var(--primary-color);
         padding-bottom: 8px;
     }


    /* ========== RESPONSIVE STYLES ========== */
    @media (max-width: 992px) { /* Adjust breakpoint */
       .filter-controls > div {
           flex-basis: 220px; /* Allow slightly more space */
       }
    }
    @media (max-width: 768px) {
      header h1 { font-size: 1.5rem; padding: 0 40px;} /* Adjust padding */
       #themeToggle { font-size: 1rem; inset-inline-end: 10px; }
      nav {
        inset-block-start: 0;
        padding: 10px 5px;
      }
       nav .nav-item {
           font-size: 0.9rem;
           padding: 8px 12px;
           margin: 3px 5px;
       }
      .container {
          margin: 20px auto;
          padding: 15px;
      }
      h2 { font-size: 1.4rem; margin-block-end: 20px; }
      .modal-content {
        inline-size: 95%;
        padding: 20px;
        max-inline-size: 95%; /* Allow wider modal on mobile */
      }
      /* Improve table on mobile - stack or smaller font? Simple scroll is already there */
      th, td { padding: 10px 8px; font-size: 0.9rem;}
      td button { font-size: 0.8rem; padding: 4px 8px;}

       button { padding: 12px 15px; }
       .filter-controls { flex-direction: column; align-items: stretch; }
       .filter-controls > div { flex-basis: auto; inline-size: 100%; }
       .filter-controls input[type="number"] { inline-size: 100%; margin-bottom: 5px;}
       .dashboard-card { padding: 15px;}
       #siswaDetailModalContent .siswa-info { grid-template-columns: 1fr; } /* Stack info on mobile */
    }
     @media (max-width: 480px) {
         header h1 { font-size: 1.3rem; padding: 0 35px;}
         nav { flex-wrap: nowrap; overflow-x: auto; justify-content: flex-start; }
         nav .nav-item { flex-shrink: 0; }
         th, td { font-size: 0.85rem;}
     }
  </style>
</head>
<body data-theme="light"> <!-- Default theme -->

  <!-- Notification Area -->
  <div id="notification-area"></div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <span class="close" id="confirmModalClose">&times;</span>
      <h3>Konfirmasi</h3>
      <p id="confirmModalMessage" style="margin: 20px 0;">Apakah Anda yakin?</p>
      <div class="modal-actions">
        <button id="confirmModalCancel" class="btn btn-secondary">Batal</button>
        <button id="confirmModalConfirm" class="btn btn-danger">Konfirmasi</button>
      </div>
    </div>
  </div>

  <!-- Siswa Detail Modal -->
  <div id="siswaDetailModal" class="modal">
      <div id="siswaDetailModalContent" class="modal-content">
          <span class="close" id="siswaDetailModalClose">&times;</span>
          <h3>Detail Siswa & Riwayat Absensi</h3>
          <div class="siswa-info">
              <p><strong>Nama:</strong> <span id="detailNamaSiswa">-</span></p>
              <p><strong>Kelas:</strong> <span id="detailKelasSiswa">-</span></p>
              <p><strong>NIS:</strong> <span id="detailNisSiswa">-</span></p>
              <p><strong>Wali Kelas:</strong> <span id="detailWaliKelasSiswa">-</span></p>
              <p><strong>Total Terlambat:</strong> <span id="detailTotalTerlambat">-</span></p>
              <p><strong>Total Izin:</strong> <span id="detailTotalIzin">-</span></p>
              <p><strong>Total Sakit:</strong> <span id="detailTotalSakit">-</span></p>
              <p><strong>Total Alpha:</strong> <span id="detailTotalAlpha">-</span></p>
              <p><strong>Total Poin Pelanggaran:</strong> <span id="detailTotalPoin" style="font-weight: bold; color: var(--danger-color);">-</span></p>
          </div>
          <h4>Riwayat:</h4>
          <div id="siswaDetailHistoryTableContainer" class="table-container">
              <table>
                  <thead>
                      <tr>
                          <th>Tanggal</th>
                          <th>Status</th>
                          <th>Waktu</th>
                          <th>Alasan</th>
                          <th>Pengisi</th>
                          <th>Poin</th>
                      </tr>
                  </thead>
                  <tbody id="siswaDetailHistoryTableBody">
                      <tr><td colspan="6" style="text-align:center;">Memuat riwayat...</td></tr>
                  </tbody>
              </table>
          </div>
          <div class="modal-actions">
              <!-- PENAMBAHAN FITUR BARU -->
              <button id="btnDownloadSiswaReport" class="btn btn-success">Download Laporan (Excel)</button>
              <button id="siswaDetailModalCloseBtn" class="btn btn-secondary">Tutup</button>
          </div>
      </div>
  </div>

  <!-- HEADER -->
  <header>
    <h1>Absensi & Keterlambatan</h1>
    <button id="themeToggle" title="Ganti Tema"><i class="fas fa-sun"></i></button>
  </header>

  <!-- NAVBAR - REFACTORED -->
  <nav id="mainNav">
    <a href="#" id="navHome" class="nav-item active">Home</a>
    <a href="#" id="navAbsensi" class="nav-item">Input Absensi</a>
    <a href="#" id="navLaporan" class="nav-item">Laporan</a>
    <a href="#" id="navManajemen" class="nav-item">Manajemen</a>
    <a href="#" id="navBantuan" class="nav-item">Bantuan</a>
  </nav>

  <!-- MAIN CONTAINER -->
  <div class="container">

    <!-- ========== SCREEN: HOME (DASHBOARD) ========== -->
    <div id="homeScreen" class="screen active">
      <h2>Dashboard Home</h2>
      <div class="dashboard-section">
        <div class="dashboard-card">
          <h3>Grafik Keterlambatan Siswa (Bulan Terakhir)</h3>
          <div id="chartLatenessLineContainer">
            <canvas id="chartLatenessLine" style="max-inline-size:100%;"></canvas>
            <div class="loader-container" style="display: none;">
                <div class="loader"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="dashboard-section">
        <div class="dashboard-card">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <h3 style="margin-bottom: 0;">Top 5 Siswa Terbanyak</h3>
                <div style="flex-basis: 200px;">
                    <select id="dashboardTop5Select" style="padding: 8px;">
                        <option value="late">Terlambat</option>
                        <option value="izin">Izin</option>
                        <option value="sakit">Sakit</option>
                        <option value="alpha">Alpha</option>
                        <option value="dipulangkan">Dipulangkan</option>
                    </select>
                </div>
            </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Nama Siswa</th>
                  <th id="dashboardTop5Header">Total Keterlambatan</th>
                </tr>
              </thead>
              <tbody id="dashboardTop5TableBody">
                 <tr><td colspan="3" style="text-align:center;">Memuat data...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ========== SCREEN: INPUT ABSENSI (REFACTORED with TABS) ========== -->
    <div id="absensiScreen" class="screen">
        <div class="sub-nav">
            <button class="sub-nav-item active" data-target="singleAbsensiContent">Input Tunggal</button>
            <button class="sub-nav-item" data-target="bulkAbsensiContent">Input Massal (Bulk)</button>
        </div>

        <!-- Sub-Screen: Single Input -->
        <div id="singleAbsensiContent" class="sub-screen active">
            <h2>Form Absensi Siswa</h2>
            <div id="absensiStatusBox" class="status-box info" style="display:none;"></div>
            <form id="absensiForm">
                <div class="input-group">
                    <label for="namaSiswa">Nama Siswa:</label>
                    <input type="text" id="namaSiswa" list="siswaList" required>
                    <datalist id="siswaList">
                    </datalist>
                </div>
                <div class="input-group">
                    <label for="tanggalAbsen">Tanggal:</label>
                    <input type="date" id="tanggalAbsen" required>
                    <small id="holidayWarning" style="color: red; display:none; margin-top: 5px;">Tanggal terpilih adalah hari libur.</small>
                </div>
                <div class="input-group">
                    <label for="statusKedatangan">Status Kedatangan:</label>
                    <select id="statusKedatangan" required>
                    <option value="">-- Pilih Status --</option>
                    <option value="late">Terlambat</option>
                    <option value="izin">Izin</option>
                    <option value="sakit">Sakit</option>
                    <option value="alpha">Alpha</option>
                    <option value="dipulangkan">Dipulangkan</option>
                    </select>
                </div>
                <div id="waktuTerlambatContainer" class="input-group" style="display:none;">
                    <label for="waktuTerlambat">Waktu Kedatangan (Jika Terlambat):</label>
                    <input type="time" id="waktuTerlambat">
                </div>
                <div id="sakitDetailContainer" class="input-group" style="display:none;">
                    <label>Detail Sakit:</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="sakitSurat" name="sakitDetail" value="surat">
                            <label for="sakitSurat">Dengan Surat Dokter</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="sakitTanpaSurat" name="sakitDetail" value="tanpa_surat" checked>
                            <label for="sakitTanpaSurat">Tanpa Surat Dokter</label>
                        </div>
                    </div>
                </div>
                <div class="input-group">
                    <label for="dropdownAlasan">Alasan (Jika Terlambat/Izin/Sakit):</label>
                    <select id="dropdownAlasan">
                    <option value="">-- Pilih Alasan Umum --</option>
                    <option value="Bangun kesiangan">Bangun kesiangan</option>
                    <option value="Macet/Transportasi bermasalah">Macet/Transportasi bermasalah</option>
                    <option value="Alasan kesehatan (sakit ringan)">Alasan kesehatan (sakit ringan)</option>
                    <option value="Menemani keluarga yang membutuhkan">Menemani keluarga yang membutuhkan</option>
                    <option value="Lupa membawa peralatan sekolah">Lupa membawa peralatan sekolah</option>
                    <option value="Cuaca ekstrem (hujan/banjir)">Cuaca ekstrem (hujan/banjir)</option>
                    <option value="Urusan keluarga mendadak">Urusan keluarga mendadak</option>
                    <option value="Lainnya">Lainnya (Isi di bawah)</option>
                    </select>
                </div>
                <div id="alasanCustomContainer" class="input-group" style="display:none;">
                <label for="alasanCustom">Alasan Lainnya / Detail:</label>
                <input type="text" id="alasanCustom" placeholder="Tulis alasan lainnya atau detail...">
                </div>
                <div class="form-actions">
                    <button type="submit" id="btnCatatAbsensi" class="btn btn-primary">Catat Absensi</button>
                </div>
            </form>
        </div>

        <!-- Sub-Screen: Bulk Input -->
        <div id="bulkAbsensiContent" class="sub-screen">
            <h2>Input Absensi Massal (Bulk)</h2>
            <form id="bulkAbsensiForm">
                <div class="input-group">
                    <label for="bulkTanggalAbsen">Tanggal:</label>
                    <input type="date" id="bulkTanggalAbsen" required>
                    <small id="bulkHolidayWarning" style="color: red; display:none; margin-top: 5px;">Tanggal terpilih adalah hari libur.</small>
                </div>
                <div class="input-group">
                    <label for="bulkStatusKedatangan">Status Kedatangan (Sama untuk Semua):</label>
                    <select id="bulkStatusKedatangan" required>
                    <option value="">-- Pilih Status --</option>
                    <option value="late">Terlambat</option>
                    <option value="izin">Izin</option>
                    <option value="sakit">Sakit</option>
                    <option value="alpha">Alpha</option>
                    <option value="dipulangkan">Dipulangkan</option>
                    </select>
                </div>
                <div id="bulkWaktuTerlambatContainer" class="input-group" style="display:none;">
                    <label for="bulkWaktuTerlambat">Waktu Kedatangan (Jika Terlambat):</label>
                    <input type="time" id="bulkWaktuTerlambat">
                </div>
                <div id="bulkSakitDetailContainer" class="input-group" style="display:none;">
                    <label>Detail Sakit:</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="bulkSakitSurat" name="bulkSakitDetail" value="surat">
                            <label for="bulkSakitSurat">Dengan Surat Dokter</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="bulkSakitTanpaSurat" name="bulkSakitDetail" value="tanpa_surat" checked>
                            <label for="bulkSakitTanpaSurat">Tanpa Surat Dokter</label>
                        </div>
                    </div>
                </div>
                <div class="input-group">
                    <label for="bulkDropdownAlasan">Alasan Umum (Sama untuk Semua, Opsional):</label>
                    <select id="bulkDropdownAlasan">
                    <option value="">-- Tidak Ada Alasan Umum --</option>
                    <option value="Bangun kesiangan">Bangun kesiangan</option>
                    <option value="Macet/Transportasi bermasalah">Macet/Transportasi bermasalah</option>
                    <option value="Alasan kesehatan (sakit ringan)">Alasan kesehatan (sakit ringan)</option>
                    <option value="Menemani keluarga yang membutuhkan">Menemani keluarga yang membutuhkan</option>
                    <option value="Lupa membawa peralatan sekolah">Lupa membawa peralatan sekolah</option>
                    <option value="Cuaca ekstrem (hujan/banjir)">Cuaca ekstrem (hujan/banjir)</option>
                    <option value="Urusan keluarga mendadak">Urusan keluarga mendadak</option>
                    <option value="Lainnya">Lainnya (Isi di bawah)</option>
                    </select>
                </div>
                <div id="bulkAlasanCustomContainer" class="input-group" style="display:none;">
                    <label for="bulkAlasanCustom">Alasan Lainnya / Detail (Sama untuk Semua):</label>
                    <input type="text" id="bulkAlasanCustom" placeholder="Tulis alasan lainnya atau detail...">
                </div>
                <div class="input-group">
                    <label>Pilih Siswa:</label>
                    <input type="search" id="bulkSearchSiswa" placeholder="Cari siswa untuk ditambahkan..." style="margin-bottom: 10px;">
                    <div id="bulkAbsensiSiswaList">
                        Memuat daftar siswa...
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" id="btnCatatBulkAbsensi" class="btn btn-primary">Catat Absensi Bulk</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========== SCREEN: LAPORAN (REFACTORED with TABS) ========== -->
    <div id="laporanScreen" class="screen">
        <div class="sub-nav">
            <button class="sub-nav-item active" data-target="terlambatScreen">Data Keterlambatan</button>
            <button class="sub-nav-item" data-target="historyScreen">Riwayat Absensi</button>
            <button class="sub-nav-item" data-target="statistikScreen">Statistik</button>
        </div>

        <!-- Sub-Screen: Data Keterlambatan -->
        <div id="terlambatScreen" class="sub-screen active">
            <h2>Data Akumulasi Keterlambatan Siswa</h2>
            <div class="filter-section">
                <h3>Filter Keterlambatan</h3>
                <div class="filter-controls">
                    <div>
                        <label for="searchKeterlambatan">Cari Nama:</label>
                        <input type="search" id="searchKeterlambatan" placeholder="Cari Nama Siswa...">
                    </div>
                    <div>
                        <label for="filterKelasKeterlambatan">Filter Kelas:</label>
                        <select id="filterKelasKeterlambatan">
                            <option value="">Semua Kelas</option>
                        </select>
                    </div>
                    <div>
                        <label>Filter Jumlah:</label>
                        <input type="number" id="filterMinLateness" placeholder="Min" min="0" style="inline-size: 70px;">
                        -
                        <input type="number" id="filterMaxLateness" placeholder="Max" min="0" style="inline-size: 70px;">
                    </div>
                    <div>
                        <button id="btnApplyKeterlambatanFilter" class="btn btn-secondary btn-sm">Filter</button>
                        <button id="btnResetKeterlambatanFilter" class="btn btn-warning btn-sm">Reset</button>
                    </div>
                </div>
                <div id="keterlambatanFilterResult" style="display:none; margin-top:15px;" class="status-box info"></div>
            </div>
            <button id="btnResetSemuaKeterlambatan" class="btn btn-danger">Reset Semua Keterlambatan (Jadi 0)</button>
            <div class="table-container">
                <table>
                    <thead>
                    <tr>
                        <th class="sortable" data-sort-column="nama">Nama <span class="sort-icon"></span></th>
                        <th class="sortable" data-sort-column="kelas">Kelas <span class="sort-icon"></span></th>
                        <th class="sortable" data-sort-column="terlambat_total">Terlambat Total <span class="sort-icon"></span></th>
                        <th>Sisa Keterlambatan</th> <!-- NEW -->
                        <th>Aksi</th>
                    </tr>
                    </thead>
                    <tbody id="dataKeterlambatanTable">
                        <tr><td colspan="5" style="text-align:center;">Memuat data...</td></tr> <!-- Colspan updated -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sub-Screen: History -->
        <div id="historyScreen" class="sub-screen">
            <h2>Riwayat Absensi</h2>
            <div class="filter-section">
                <h3>Filter Riwayat</h3>
                <div class="filter-controls">
                    <div>
                        <label for="searchHistory">Cari Teks:</label>
                        <input type="search" id="searchHistory" placeholder="Nama, Alasan, Pengisi...">
                    </div>
                    <div>
                        <label for="filterKelasHistory">Filter Kelas:</label>
                        <select id="filterKelasHistory">
                            <option value="">Semua Kelas</option>
                        </select>
                    </div>
                    <div>
                        <label for="filterDate">Filter Harian:</label>
                        <input type="date" id="filterDate">
                    </div>
                    <div>
                        <label for="filterStartDate">Rentang Tanggal:</label>
                        <input type="date" id="filterStartDate" placeholder="Tgl Mulai">
                        <input type="date" id="filterEndDate" placeholder="Tgl Akhir" style="margin-block-start: 5px;">
                    </div>
                    <div>
                        <label for="filterStatus">Filter Status:</label>
                        <select id="filterStatus">
                            <option value="">Semua Status</option>
                            <option value="late">Terlambat</option>
                            <option value="izin">Izin</option>
                            <option value="sakit">Sakit</option>
                            <option value="alpha">Alpha</option>
                            <option value="dipulangkan">Dipulangkan</option>
                        </select>
                    </div>
                    <div style="flex-basis: 100%; text-align: end;">
                        <button id="btnApplyHistoryFilter" class="btn btn-secondary">Terapkan Filter</button>
                        <button id="btnResetHistoryFilters" class="btn btn-warning">Reset Filter</button>
                    </div>
                </div>
                <div id="filterResult" style="display:none; margin-block-start:15px;" class="status-box info"></div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                    <tr>
                        <th class="sortable" data-sort-column="tanggal">Tanggal <span class="sort-icon"></span></th>
                        <th class="sortable" data-sort-column="nama">Nama Siswa <span class="sort-icon"></span></th>
                        <th class="sortable" data-sort-column="kelas">Kelas <span class="sort-icon"></span></th>
                        <th>Status</th>
                        <th>Waktu</th>
                        <th>Alasan</th>
                        <th>Pengisi (Guru)</th>
                        <th>Aksi</th>
                    </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr><td colspan="8" style="text-align:center;">Memuat data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Sub-Screen: Statistik -->
        <div id="statistikScreen" class="sub-screen">
            <h2>Statistik Absensi & Keterlambatan</h2>
            <div class="filter-section">
                <div class="filter-controls">
                    <div>
                    <label for="chartOption">Pilih Grafik:</label>
                    <select id="chartOption">
                        <option value="siswa_telat">Top Siswa Sering Telat</option>
                        <option value="alasan_telat">Top Alasan Keterlambatan</option>
                        <option value="tren_harian_telat">Tren Harian Keterlambatan (Bulan)</option>
                        <option value="tren_kelas_telat">Keterlambatan per Kelas (Bulan)</option>
                        <option value="tren_hari_telat">Keterlambatan per Hari (Bulan)</option>
                        <option value="status_bulanan">Distribusi Status Absensi (Bulan)</option>
                        <option value="banding_bulan">Perbandingan Keterlambatan Antar Bulan</option>
                    </select>
                    </div>
                    <div>
                    <label for="statistikBulan">Pilih Bulan:</label>
                    <input type="month" id="statistikBulan">
                    </div>
                    <div id="compareMonthContainer" style="display: none;">
                        <label for="statistikBulanCompare">Bandingkan Dengan Bulan:</label>
                        <input type="month" id="statistikBulanCompare">
                    </div>
                    <div id="chartKelasFilterContainer" style="display: none;">
                        <label for="chartFilterKelas">Filter Kelas (Opsional):</label>
                        <select id="chartFilterKelas">
                            <option value="">Semua Kelas</option>
                        </select>
                    </div>
                    <div>
                        <button id="btnRenderChart" class="btn btn-primary">Tampilkan</button>
                    </div>
                </div>
            </div>
            <div id="chartStatisticContainer">
                <canvas id="chartStatistic" style="max-inline-size:100%; margin-block-start:30px; min-height: 350px;"></canvas>
                <div class="loader-container" style="display: none;">
                        <div class="loader"></div>
                </div>
                <div id="textAnalysisContainer" style="margin-top: 20px; padding: 15px; background-color: var(--nav-item-bg-color); border-radius: 5px; display:none;">
                        <h4>Analisis Tambahan:</h4>
                        <p id="analysisContent">Memuat analisis...</p>
                </div>
            </div>
            <div id="downloadSection" style="margin-block-start:30px; display:none;">
                <button id="btnDownloadMonthly" class="btn btn-success">Download Data Bulan Terpilih (Excel)</button>
                <button id="btnDownloadChart" class="btn btn-secondary">Download Grafik (PNG)</button>
            </div>
        </div>
    </div>

    <!-- ========== SCREEN: MANAJEMEN (REFACTORED with TABS) ========== -->
    <div id="manajemenScreen" class="screen">
        <div class="sub-nav">
            <button class="sub-nav-item active" data-target="dataSiswaScreen">Manajemen Siswa</button>
            <button class="sub-nav-item" data-target="tahunAjaranScreen">Tahun Ajaran</button> <!-- NEW TAB -->
            <button class="sub-nav-item" data-target="settingsScreen">Pengaturan</button>
            <button class="sub-nav-item" data-target="profileScreen">Profil & Pengisi</button>
        </div>

        <!-- Sub-Screen: Data Siswa -->
        <div id="dataSiswaScreen" class="sub-screen active">
            <h2>Manajemen Data Siswa</h2>
            <div style="margin-block-end:30px; background-color: var(--nav-item-bg-color); padding: 20px; border-radius: 8px;">
                <h3>Tambah Siswa Baru</h3>
                <form id="formTambahSiswa">
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <div> <label for="dataSiswaNama">Nama Siswa:</label> <input type="text" id="dataSiswaNama" placeholder="Nama Lengkap" required> </div>
                    <div> <label for="dataSiswaKelas">Kelas:</label> <input type="text" id="dataSiswaKelas" placeholder="Contoh: 10 IPA 1" required> </div>
                    <div> <label for="dataSiswaNIS">NIS:</label> <input type="text" id="dataSiswaNIS" placeholder="Nomor Induk Siswa" required> </div>
                    <div> <label for="dataSiswaWaliKelas">Wali Kelas:</label> <input type="text" id="dataSiswaWaliKelas" placeholder="Nama Wali Kelas" required> </div>
                    <div> <label for="dataSiswaWaliKelasTelp">No. Telp Wali Kelas (WA):</label> <input type="text" id="dataSiswaWaliKelasTelp" placeholder="Contoh: 628123456789"> </div>
                    <div> <label for="dataSiswaOrtuTelp">No. Telp Orang Tua (WA):</label> <input type="text" id="dataSiswaOrtuTelp" placeholder="Contoh: 628987654321"> </div>
                </div>
                <button type="submit" id="btnTambahSiswa" class="btn btn-primary" style="margin-block-start:15px;">Tambah Siswa</button>
                </form>
            </div>
            <div style="margin-block-end:30px; background-color: var(--nav-item-bg-color); padding: 20px; border-radius: 8px;">
                <h3>Import Data Siswa dari Excel</h3>
                <p style="font-size: 0.9em; color: #666; margin-block-end: 10px;">Logika: Tambah siswa jika NIS baru, perbarui data jika NIS sudah ada. Data lama aman. Header: `Nama`, `Kelas`, `NIS`, `WaliKelas`. Opsional: `WaliKelasTelp`, `OrtuTelp`.</p>
                <input type="file" id="importFileSiswa" accept=".xlsx, .xls">
                <button id="btnImportDataSiswa" class="btn btn-success" style="margin-block-start:10px;">Import Data</button>
            </div>
            <div style="margin-block-end:20px; display: flex; flex-wrap: wrap; align-items: center; gap: 15px;">
                <input type="search" id="searchDataSiswaTable" placeholder="Cari di tabel..." class="search-bar" style="max-inline-size: 300px; margin: 0;">
                <div class="radio-group" style="margin: 0;">
                    <div class="radio-item">
                        <input type="radio" id="filterStatusAktif" name="filterStatusAkademik" value="Aktif" checked>
                        <label for="filterStatusAktif">Siswa Aktif</label>
                    </div>
                    <div class="radio-item">
                        <input type="radio" id="filterStatusLulus" name="filterStatusAkademik" value="Lulus">
                        <label for="filterStatusLulus">Siswa Lulus</label>
                    </div>
                </div>
                <div style="margin-left: auto;">
                    <button id="btnHapusPilihSiswa" class="btn btn-warning">Hapus Siswa Terpilih</button>
                    <button id="btnHapusSemuaSiswa" class="btn btn-danger">Hapus SEMUA Siswa</button>
                </div>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                    <tr>
                        <th><input type="checkbox" id="selectAllSiswa"></th>
                        <th class="sortable" data-sort-column="nama">Nama Siswa <span class="sort-icon"></span></th>
                        <th class="sortable" data-sort-column="kelas">Kelas <span class="sort-icon"></span></th>
                        <th class="sortable" data-sort-column="nis">NIS <span class="sort-icon"></span></th>
                        <th class="sortable" data-sort-column="waliKelas">Wali Kelas <span class="sort-icon"></span></th>
                        <th>Aksi</th>
                    </tr>
                    </thead>
                    <tbody id="dataSiswaTable">
                        <tr><td colspan="6" style="text-align:center;">Memuat data...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- NEW Sub-Screen: Tahun Ajaran -->
        <div id="tahunAjaranScreen" class="sub-screen">
            <h2>Manajemen Tahun Ajaran</h2>
            <div class="dashboard-card" style="border-color: var(--warning-color);">
                <h3>Proses Kenaikan Kelas Massal</h3>
                <p>Gunakan fitur ini di akhir tahun ajaran untuk secara otomatis menaikkan jenjang kelas semua siswa. Riwayat absensi lama tidak akan berubah atau hilang.</p>
                <ul style="margin: 15px 0 25px 20px;">
                    <li>Siswa <strong>Kelas 10</strong> akan menjadi <strong>Kelas 11</strong> (misal: "10 IPA 1" -> "11 IPA 1").</li>
                    <li>Siswa <strong>Kelas 11</strong> akan menjadi <strong>Kelas 12</strong> (misal: "11 IPS 2" -> "12 IPS 2").</li>
                    <li>Siswa <strong>Kelas 12</strong> akan ditandai sebagai <strong>"Lulus"</strong> dan tidak akan muncul lagi di form absensi harian.</li>
                </ul>
                <p><strong>PERINGATAN:</strong> Tindakan ini tidak dapat dibatalkan. Pastikan semua data sudah benar sebelum melanjutkan.</p>
                <div class="form-actions" style="text-align: center;">
                    <button id="btnProsesKenaikanKelas" class="btn btn-warning" style="padding: 15px 30px; font-size: 1.1rem;">Proses Kenaikan Kelas</button>
                </div>
            </div>
        </div>

        <!-- Sub-Screen: Settings -->
        <div id="settingsScreen" class="sub-screen">
            <h2>Pengaturan Aplikasi</h2>
            <div class="setting-section" style="margin-block-end:30px;">
                <h3>Petugas Piket Guru (Harian, Max 10)</h3>
                <form id="formTambahGuru" style="display:flex; flex-wrap:wrap; gap:15px; align-items: flex-end; margin-block-end:15px; background-color: var(--nav-item-bg-color); padding: 15px; border-radius: 8px;">
                <div style="flex: 1 1 200px;">
                    <label for="guruNama">Nama Guru:</label>
                    <input type="text" id="guruNama" placeholder="Contoh: Pak Andi" required>
                </div>
                <div style="flex: 1 1 150px;">
                    <label for="guruHari">Hari Piket:</label>
                    <select id="guruHari" required>
                    <option value="">-- Pilih Hari --</option>
                    <option value="Senin">Senin</option>
                    <option value="Selasa">Selasa</option>
                    <option value="Rabu">Rabu</option>
                    <option value="Kamis">Kamis</option>
                    <option value="Jumat">Jumat</option>
                    <option value="Sabtu">Sabtu</option>
                    </select>
                </div>
                <div>
                    <button type="submit" id="btnTambahGuru" class="btn btn-primary">Tambah Guru</button>
                </div>
                </form>
                <div class="table-container">
                    <table>
                    <thead> <tr><th>Nama Guru</th><th>Hari</th><th>Aksi</th></tr> </thead>
                    <tbody id="petugasGuruTable">
                        <tr><td colspan="3" style="text-align:center;">Memuat data...</td></tr>
                    </tbody>
                    </table>
                </div>
            </div>
            <hr style="margin: 30px 0; border-color: var(--input-border-color);">
            <div class="setting-section" style="margin-block-end:30px;">
                <h3>Petugas Piket Siswa (2 Orang)</h3>
                <form id="formSimpanSiswaPiket" style="display:flex; flex-wrap:wrap; gap:15px; align-items: flex-end; margin-block-end:15px; background-color: var(--nav-item-bg-color); padding: 15px; border-radius: 8px;">
                <div style="flex: 1 1 200px;">
                    <label for="siswa1">Siswa 1:</label>
                    <input type="text" id="siswa1" list="siswaList" placeholder="Ketik nama siswa..." required>
                </div>
                <div style="flex: 1 1 200px;">
                    <label for="siswa2">Siswa 2:</label>
                    <input type="text" id="siswa2" list="siswaList" placeholder="Ketik nama siswa..." required>
                </div>
                <div>
                    <button type="submit" id="btnSimpanPetugasSiswa" class="btn btn-primary">Simpan Siswa</button>
                </div>
                </form>
                <div id="currentPetugasSiswaDisplay">
                    <h4>Petugas Siswa Saat Ini:</h4>
                    <ul id="settingsSiswaList" style="list-style-type: disc; padding-inline-start: 20px;">
                        <li>Memuat...</li>
                    </ul>
                </div>
            </div>
            <hr style="margin: 30px 0; border-color: var(--input-border-color);">
            <div class="setting-section" style="margin-block-end:30px;">
                <h3>Kelola Hari Libur</h3>
                <form id="formTambahHariLibur" style="display:flex; flex-wrap:wrap; gap:15px; align-items: flex-end; margin-block-end:15px; background-color: var(--nav-item-bg-color); padding: 15px; border-radius: 8px;">
                    <div style="flex: 1 1 150px;">
                        <label for="liburTanggal">Tanggal Libur:</label>
                        <input type="date" id="liburTanggal" required>
                    </div>
                    <div style="flex: 1 1 250px;">
                        <label for="liburKeterangan">Keterangan:</label>
                        <input type="text" id="liburKeterangan" placeholder="Contoh: Libur Nasional Maulid Nabi" required>
                    </div>
                    <div>
                        <button type="submit" id="btnTambahHariLibur" class="btn btn-primary">Tambah Libur</button>
                    </div>
                </form>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Tanggal</th><th>Keterangan</th><th>Aksi</th></tr></thead>
                        <tbody id="hariLiburTable">
                            <tr><td colspan="3" style="text-align:center;">Memuat data hari libur...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <hr style="margin: 30px 0; border-color: var(--input-border-color);">
            <div class="setting-section">
                <h3>Pengaturan Poin Pelanggaran</h3>
                <form id="formPoinPelanggaran" style="display:flex; flex-wrap:wrap; gap:15px; align-items: flex-end; margin-block-end:15px; background-color: var(--nav-item-bg-color); padding: 15px; border-radius: 8px;">
                    <div style="flex: 1 1 200px;">
                        <label for="poinTerlambat">Poin per Keterlambatan:</label>
                        <input type="number" id="poinTerlambat" min="0" value="1" required>
                    </div>
                    <div style="flex: 1 1 200px;">
                        <label for="poinDipulangkan">Poin jika Dipulangkan:</label>
                        <input type="number" id="poinDipulangkan" min="0" value="5" required>
                    </div>
                    <div>
                        <button type="submit" id="btnSimpanPoin" class="btn btn-primary">Simpan Poin</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Sub-Screen: Profile -->
        <div id="profileScreen" class="sub-screen">
            <h2>Profil Petugas & Pengisi</h2>
            <div class="dashboard-card" style="margin-block-end: 30px; background-color: var(--nav-item-bg-color);">
                <p style="font-size: 1.1rem;">Total Data Absensi Tercatat (Aktif + Arsip): <strong id="profileAbsensiCount">Memuat...</strong></p>
            </div>
            <div class="profile-section" style="margin-block-end:30px;">
                <h3>Daftar Petugas Guru (Urutan Senin–Sabtu)</h3>
                <div class="table-container">
                    <table>
                    <thead> <tr><th>Hari</th><th>Nama Guru</th><th>Aksi</th></tr> </thead>
                    <tbody id="profileGuruTbody">
                        <tr><td colspan="3" style="text-align:center;">Memuat data...</td></tr>
                    </tbody>
                    </table>
                </div>
            </div>
            <div class="profile-section" style="margin-block-end:30px;">
                <h3>Daftar Petugas Siswa Saat Ini (2 Orang)</h3>
                <ul id="profileSiswaList" style="list-style-type: disc; padding-inline-start: 20px; font-size: 1.1rem;">
                    <li>Memuat...</li>
                </ul>
            </div>
            <div class="profile-section">
                <h3>Pengisi Absensi Hari Ini</h3>
                <div style="background-color: var(--nav-item-bg-color); padding: 20px; border-radius: 8px;">
                    <p>Hari ini: <strong id="hariAktualSpan">-</strong></p>
                    <div style="display:flex; flex-wrap:wrap; gap:15px; align-items: flex-end; margin-block-start:10px;">
                    <div style="flex:1;">
                        <label for="dropdownPengisi">Pilih Guru Pengisi (Sesuai Jadwal Piket Hari Ini):</label>
                        <select id="dropdownPengisi">
                        <option value="">Memuat guru...</option>
                        </select>
                    </div>
                    <div>
                        <button id="btnSetPengisi" class="btn btn-primary">Set Sebagai Pengisi</button>
                    </div>
                    </div>
                    <p style="margin-block-start:20px; font-weight: bold;">Pengisi Saat Ini: <strong id="currentPengisiSpan">-</strong></p>
                </div>
            </div>
            <div id="editGuruModal" class="modal">
                <div class="modal-content">
                <span class="close" id="editGuruModalClose">&times;</span>
                <h3>Edit Guru Piket</h3>
                <form id="editGuruForm">
                    <input type="hidden" id="editGuruId">
                    <div class="input-group"> <label for="editGuruNama">Nama Guru:</label> <input type="text" id="editGuruNama" required> </div>
                    <div class="input-group"> <label for="editGuruHari">Hari Piket:</label> <select id="editGuruHari" required> <option value="">-- Pilih Hari --</option> <option value="Senin">Senin</option> <option value="Selasa">Selasa</option> <option value="Rabu">Rabu</option> <option value="Kamis">Kamis</option> <option value="Jumat">Jumat</option> <option value="Sabtu">Sabtu</option> </select> </div>
                    <div class="modal-actions"> <button type="button" id="editGuruModalCancel" class="btn btn-secondary">Batal</button> <button type="submit" id="btnSimpanEditGuru" class="btn btn-primary">Simpan Perubahan</button> </div>
                </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== SCREEN: BANTUAN ========== -->
    <div id="bantuanScreen" class="screen">
        <h2>Bantuan Penggunaan Aplikasi</h2>
        <div class="help-section">
            <h3>Navigasi</h3>
            <p>Gunakan menu navigasi di bagian atas untuk berpindah antar halaman utama:</p>
            <ul>
                <li><strong>Home:</strong> Tampilan dashboard ringkasan.</li>
                <li><strong>Input Absensi:</strong> Form untuk mencatat absensi harian (pilih mode Tunggal atau Massal/Bulk).</li>
                <li><strong>Laporan:</strong> Lihat semua data dalam format tabel, riwayat, atau grafik. Gunakan *tab* di atas untuk memilih tampilan.</li>
                <li><strong>Manajemen:</strong> Kelola data master siswa, tahun ajaran, pengaturan, dan profil pengisi.</li>
                <li><strong>Bantuan:</strong> Halaman ini.</li>
            </ul>
            <p>Tombol <i class="fas fa-sun"></i>/<i class="fas fa-moon"></i> di kanan atas untuk mengganti tema tampilan (terang/gelap).</p>
        </div>
        <div class="help-section">
            <h3>Input Absensi</h3>
            <ol>
                <li>Pilih menu 'Input Absensi'.</li>
                <li>Pilih mode 'Input Tunggal' atau 'Input Massal (Bulk)'.</li>
                <li>Lengkapi form sesuai kebutuhan. Untuk mode Massal, centang semua siswa yang relevan.</li>
                <li>Klik tombol 'Catat Absensi'.</li>
            </ol>
            <p><strong>Penting:</strong> Pastikan 'Pengisi Saat Ini' di halaman Manajemen > Profil & Pengisi sudah diatur ke nama Anda sebelum mencatat.</p>
        </div>
        <div class="help-section">
            <h3>Melihat Laporan</h3>
            <ul>
                <li>Pilih menu 'Laporan'.</li>
                <li>Pilih *tab* yang diinginkan: 'Data Keterlambatan', 'Riwayat Absensi', atau 'Statistik'.</li>
                <li>Gunakan fitur filter dan pencarian yang tersedia di setiap *tab* untuk menemukan data spesifik.</li>
                <li>Klik pada nama siswa di tabel manapun untuk melihat detail riwayat siswa tersebut.</li>
            </ul>
        </div>
        <div class="help-section">
           <h3>Manajemen & Pengaturan</h3>
            <ul>
                <li>Pilih menu 'Manajemen'.</li>
                <li>Pilih *tab* yang diinginkan: 'Manajemen Siswa', 'Tahun Ajaran', 'Pengaturan', atau 'Profil & Pengisi'.</li>
                <li>Lakukan perubahan yang diperlukan, seperti menambah siswa, memproses kenaikan kelas, mengatur petugas piket, atau menambahkan hari libur.</li>
            </ul>
        </div>
    </div>

  </div> <!-- End Container -->

  <!-- FOOTER -->
  <footer>
    <div class="footer-line"></div>
    <p>
      Created by <br>
      Antonius Elga Kurnia, S.Pd.
    </p>
  </footer>

  <!-- JAVASCRIPT -->
  <script>
    // --- AWAL TAMBAHAN INISIALISASI MANUAL ---
    const firebaseConfig = {
      apiKey: "AIzaSyBOIKO90GdqhRFisZIgK1B8DmYHfMrhp9k",
      authDomain: "absensiketerlambatanapp-10d87.firebaseapp.com",
      projectId: "absensiketerlambatanapp-10d87",
      storageBucket: "absensiketerlambatanapp-10d87.appspot.com",
      messagingSenderId: "1049369715348",
      appId: "1:1049369715348:web:d2d3333fbaaaeeccba8a81"
    };

    if (!firebase.apps.length) {
       firebase.initializeApp(firebaseConfig);
       console.log("Firebase Initialized Manually from Config.");
    } else {
       firebase.app();
       console.log("Firebase already initialized.");
    }
    // --- AKHIR TAMBAHAN INISIALISASI MANUAL ---


    /********************************************************
     *                ELEMENT REFERENCES
     ********************************************************/
    // Modals & Close Buttons
    const editGuruModal = document.getElementById('editGuruModal');
    const confirmModal = document.getElementById('confirmModal');
    const siswaDetailModal = document.getElementById('siswaDetailModal');
    const confirmModalMessage = document.getElementById('confirmModalMessage');
    const confirmModalConfirm = document.getElementById('confirmModalConfirm');
    const confirmModalCancel = document.getElementById('confirmModalCancel');
    const confirmModalClose = document.getElementById('confirmModalClose');
    const editGuruModalClose = document.getElementById('editGuruModalClose');
    const editGuruModalCancel = document.getElementById('editGuruModalCancel');
    const siswaDetailModalClose = document.getElementById('siswaDetailModalClose');
    const siswaDetailModalCloseBtn = document.getElementById('siswaDetailModalCloseBtn');
    const btnDownloadSiswaReport = document.getElementById('btnDownloadSiswaReport'); // PENAMBAHAN BARU

    let notificationArea;

    // Screens (Main Containers)
    const screens = document.querySelectorAll('.screen');

    // Navigation & Theme
    const mainNav = document.getElementById('mainNav');
    const navItems = mainNav.querySelectorAll('.nav-item');
    const themeToggleButton = document.getElementById('themeToggle');

    // Home Screen
    const chartLatenessLineContainer = document.getElementById('chartLatenessLineContainer');
    const chartLatenessLineCanvas = document.getElementById('chartLatenessLine');
    const dashboardTop5TableBody = document.getElementById('dashboardTop5TableBody');
    const dashboardTop5Select = document.getElementById('dashboardTop5Select'); // NEW
    const dashboardTop5Header = document.getElementById('dashboardTop5Header'); // NEW

    // Absensi Screen (Single Input)
    const absensiForm = document.getElementById('absensiForm');
    const namaSiswaInput = document.getElementById('namaSiswa');
    const siswaDataList = document.getElementById('siswaList');
    const tanggalAbsenInput = document.getElementById('tanggalAbsen');
    const holidayWarning = document.getElementById('holidayWarning');
    const statusKedatanganSelect = document.getElementById('statusKedatangan');
    const waktuTerlambatContainer = document.getElementById('waktuTerlambatContainer');
    const waktuTerlambatInput = document.getElementById('waktuTerlambat');
    const sakitDetailContainer = document.getElementById('sakitDetailContainer');
    const dropdownAlasanSelect = document.getElementById('dropdownAlasan');
    const alasanCustomContainer = document.getElementById('alasanCustomContainer');
    const alasanCustomInput = document.getElementById('alasanCustom');
    const absensiStatusBox = document.getElementById('absensiStatusBox');
    const btnCatatAbsensi = document.getElementById('btnCatatAbsensi');

     // Absensi Screen (Bulk Input)
     const bulkAbsensiForm = document.getElementById('bulkAbsensiForm');
     const bulkTanggalAbsenInput = document.getElementById('bulkTanggalAbsen');
     const bulkHolidayWarning = document.getElementById('bulkHolidayWarning');
     const bulkStatusKedatanganSelect = document.getElementById('bulkStatusKedatangan');
     const bulkWaktuTerlambatContainer = document.getElementById('bulkWaktuTerlambatContainer');
     const bulkWaktuTerlambatInput = document.getElementById('bulkWaktuTerlambat');
     const bulkSakitDetailContainer = document.getElementById('bulkSakitDetailContainer');
     const bulkDropdownAlasanSelect = document.getElementById('bulkDropdownAlasan');
     const bulkAlasanCustomContainer = document.getElementById('bulkAlasanCustomContainer');
     const bulkAlasanCustomInput = document.getElementById('bulkAlasanCustom');
     const bulkSearchSiswaInput = document.getElementById('bulkSearchSiswa');
     const bulkAbsensiSiswaListDiv = document.getElementById('bulkAbsensiSiswaList');
     const btnCatatBulkAbsensi = document.getElementById('btnCatatBulkAbsensi');

    // Laporan > Keterlambatan Screen
    const dataKeterlambatanTableBody = document.getElementById('dataKeterlambatanTable');
    const btnResetSemuaKeterlambatan = document.getElementById('btnResetSemuaKeterlambatan');
    const searchKeterlambatanInput = document.getElementById('searchKeterlambatan');
    const filterKelasKeterlambatanSelect = document.getElementById('filterKelasKeterlambatan');
    const filterMinLatenessInput = document.getElementById('filterMinLateness');
    const filterMaxLatenessInput = document.getElementById('filterMaxLateness');
    const btnApplyKeterlambatanFilter = document.getElementById('btnApplyKeterlambatanFilter');
    const btnResetKeterlambatanFilter = document.getElementById('btnResetKeterlambatanFilter');
    const keterlambatanFilterResultDiv = document.getElementById('keterlambatanFilterResult');

    // Laporan > History Screen
    const historyTableBody = document.getElementById('historyTableBody');
    const filterDateInput = document.getElementById('filterDate');
    const filterStartDateInput = document.getElementById('filterStartDate');
    const filterEndDateInput = document.getElementById('filterEndDate');
    const btnResetHistoryFilters = document.getElementById('btnResetHistoryFilters');
    const filterResultDiv = document.getElementById('filterResult');
    const searchHistoryInput = document.getElementById('searchHistory');
    const filterStatusSelect = document.getElementById('filterStatus');
    const filterKelasHistorySelect = document.getElementById('filterKelasHistory');
    const btnApplyHistoryFilter = document.getElementById('btnApplyHistoryFilter');

    // Laporan > Statistik Screen
    const chartOptionSelect = document.getElementById('chartOption');
    const statistikBulanInput = document.getElementById('statistikBulan');
    const compareMonthContainer = document.getElementById('compareMonthContainer');
    const statistikBulanCompareInput = document.getElementById('statistikBulanCompare');
    const chartKelasFilterContainer = document.getElementById('chartKelasFilterContainer');
    const chartFilterKelasSelect = document.getElementById('chartFilterKelas');
    const btnRenderChart = document.getElementById('btnRenderChart');
    const chartStatisticContainer = document.getElementById('chartStatisticContainer');
    const chartStatisticCanvas = document.getElementById('chartStatistic');
    const textAnalysisContainer = document.getElementById('textAnalysisContainer');
    const analysisContentP = document.getElementById('analysisContent');
    const downloadSectionDiv = document.getElementById('downloadSection');
    const btnDownloadMonthly = document.getElementById('btnDownloadMonthly');
    const btnDownloadChart = document.getElementById('btnDownloadChart');

    // Manajemen > Settings Screen
    const formTambahGuru = document.getElementById('formTambahGuru');
    const guruNamaInput = document.getElementById('guruNama');
    const guruHariSelect = document.getElementById('guruHari');
    const btnTambahGuru = document.getElementById('btnTambahGuru');
    const petugasGuruTableBody = document.getElementById('petugasGuruTable');
    const formSimpanSiswaPiket = document.getElementById('formSimpanSiswaPiket');
    const siswa1Input = document.getElementById('siswa1');
    const siswa2Input = document.getElementById('siswa2');
    const btnSimpanPetugasSiswa = document.getElementById('btnSimpanPetugasSiswa');
    const settingsSiswaList = document.getElementById('settingsSiswaList');
    const formTambahHariLibur = document.getElementById('formTambahHariLibur');
    const liburTanggalInput = document.getElementById('liburTanggal');
    const liburKeteranganInput = document.getElementById('liburKeterangan');
    const btnTambahHariLibur = document.getElementById('btnTambahHariLibur');
    const hariLiburTableBody = document.getElementById('hariLiburTable');
    const formPoinPelanggaran = document.getElementById('formPoinPelanggaran');
    const poinTerlambatInput = document.getElementById('poinTerlambat');
    const poinDipulangkanInput = document.getElementById('poinDipulangkan');
    const btnSimpanPoin = document.getElementById('btnSimpanPoin');

    // Manajemen > Profile Screen
    const profileAbsensiCountSpan = document.getElementById('profileAbsensiCount');
    const profileGuruTbody = document.getElementById('profileGuruTbody');
    const profileSiswaList = document.getElementById('profileSiswaList');
    const hariAktualSpan = document.getElementById('hariAktualSpan');
    const dropdownPengisiSelect = document.getElementById('dropdownPengisi');
    const btnSetPengisi = document.getElementById('btnSetPengisi');
    const currentPengisiSpan = document.getElementById('currentPengisiSpan');
    const editGuruForm = document.getElementById('editGuruForm');
    const editGuruIdInput = document.getElementById('editGuruId');
    const editGuruNamaInput = document.getElementById('editGuruNama');
    const editGuruHariSelect = document.getElementById('editGuruHari');
    const btnSimpanEditGuru = document.getElementById('btnSimpanEditGuru');

    // Manajemen > Data Siswa Screen
    const formTambahSiswa = document.getElementById('formTambahSiswa');
    const dataSiswaNamaInput = document.getElementById('dataSiswaNama');
    const dataSiswaKelasInput = document.getElementById('dataSiswaKelas');
    const dataSiswaNISInput = document.getElementById('dataSiswaNIS');
    const dataSiswaWaliKelasInput = document.getElementById('dataSiswaWaliKelas');
    const dataSiswaWaliKelasTelpInput = document.getElementById('dataSiswaWaliKelasTelp'); // NEW
    const dataSiswaOrtuTelpInput = document.getElementById('dataSiswaOrtuTelp'); // NEW
    const btnTambahSiswa = document.getElementById('btnTambahSiswa');
    const importFileSiswaInput = document.getElementById('importFileSiswa');
    const btnImportDataSiswa = document.getElementById('btnImportDataSiswa');
    const btnHapusSemuaSiswa = document.getElementById('btnHapusSemuaSiswa');
    const btnHapusPilihSiswa = document.getElementById('btnHapusPilihSiswa');
    const dataSiswaTableBody = document.getElementById('dataSiswaTable');
    const selectAllSiswaCheckbox = document.getElementById('selectAllSiswa');
    const searchDataSiswaTableInput = document.getElementById('searchDataSiswaTable');
    const filterStatusAkademikRadios = document.querySelectorAll('input[name="filterStatusAkademik"]'); // NEW

    // Manajemen > Tahun Ajaran Screen (NEW)
    const btnProsesKenaikanKelas = document.getElementById('btnProsesKenaikanKelas');

    // Siswa Detail Modal Elements
    const detailNamaSiswaSpan = document.getElementById('detailNamaSiswa');
    const detailKelasSiswaSpan = document.getElementById('detailKelasSiswa');
    const detailNisSiswaSpan = document.getElementById('detailNisSiswa');
    const detailWaliKelasSiswaSpan = document.getElementById('detailWaliKelasSiswa');
    const detailTotalTerlambatSpan = document.getElementById('detailTotalTerlambat');
    const detailTotalIzinSpan = document.getElementById('detailTotalIzin');
    const detailTotalSakitSpan = document.getElementById('detailTotalSakit');
    const detailTotalAlphaSpan = document.getElementById('detailTotalAlpha');
    const detailTotalPoinSpan = document.getElementById('detailTotalPoin');
    const siswaDetailHistoryTableBody = document.getElementById('siswaDetailHistoryTableBody');


    /********************************************************
     *                GLOBAL VAR & STATE
     ********************************************************/
    let currentScreen = "homeScreen";
    let db;

     // Data Arrays
     let petugasGuru = [];
     let petugasSiswa = [];
     let currentPengisi = "";
     let historyAbsensi = [];
     let archiveAbsensi = [];
     let databaseSiswa = []; // {id, nama, kelas, nis, waliKelas, waliKelasTelp?, ortuTelp?, latenessResetDate?, status_akademik?}
     let dataKeterlambatan = []; // {nama, kelas, terlambat_total}
     let hariLibur = [];
     let top5Data = {}; // NEW: { late: [], izin: [], sakit: [], alpha: [], dipulangkan: [] }
     let poinSettings = { late: 1, dipulangkan: 5 }; // Default values

     // Chart Objects
     let chartObj = null;
     let latenessLineChart = null;

     // Sorting State
     let historySort = { column: 'tanggal', direction: 'desc' };
     let siswaSort = { column: 'nama', direction: 'asc' };
     let keterlambatanSort = { column: 'terlambat_total', direction: 'desc' };

     // Filtering State
     let currentHistoryFilters = {};
     let currentKeterlambatanFilters = {};
     let currentSiswaStatusFilter = 'Aktif'; // NEW

     // Other constants
     const dayOrder = ["Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];
     const lateThreshold = 3;

     // PENAMBAHAN BARU: Untuk menyimpan data siswa di modal
     let currentSiswaDetail = null;


    /********************************************************
     *             NOTIFICATION & MODAL SYSTEM
     ********************************************************/
    function showNotification(message, type = 'info', duration = 4000) {
        if (!notificationArea) {
            console.error("Notification area not found! Cannot show notification:", message);
            return;
        }
        const toast = document.createElement('div');
        toast.classList.add('toast', `toast-${type}`);
        toast.textContent = message;
        notificationArea.appendChild(toast);

        setTimeout(() => { toast.classList.add('show'); }, 10);

        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => {
                if (toast.parentNode) toast.parentNode.removeChild(toast);
            }, { once: true });
        }, duration);
    }

    let currentConfirmCallback = null;
    function showConfirmModal(message, onConfirm) {
        currentConfirmCallback = onConfirm;
        confirmModalMessage.innerHTML = message; // Use innerHTML to support simple HTML like <strong>
        confirmModal.style.display = 'flex';
    }
    function closeConfirmModal() {
        confirmModal.style.display = 'none';
        currentConfirmCallback = null;
    }
    confirmModalConfirm.addEventListener('click', () => {
        if (typeof currentConfirmCallback === 'function') currentConfirmCallback();
        closeConfirmModal();
    });
    confirmModalCancel.addEventListener('click', closeConfirmModal);
    confirmModalClose.addEventListener('click', closeConfirmModal);

     function showSiswaDetailModal(namaSiswa) {
         const siswa = databaseSiswa.find(s => s.nama.toLowerCase() === namaSiswa.toLowerCase());
         const keterlambatanData = dataKeterlambatan.find(k => k.nama.toLowerCase() === namaSiswa.toLowerCase());
         const combinedHistory = [...historyAbsensi, ...archiveAbsensi];
         const siswaHistory = combinedHistory
                                .filter(rec => rec.nama.toLowerCase() === namaSiswa.toLowerCase())
                                .sort((a,b) => b.tanggal.localeCompare(a.tanggal));

         if (!siswa) {
             showNotification(`Data siswa "${namaSiswa}" tidak ditemukan.`, "error");
             return;
         }

         currentSiswaDetail = {
             siswa,
             keterlambatanData,
             siswaHistory
         };

         const totalIzin = siswaHistory.filter(r => r.status === 'izin').length;
         const totalSakit = siswaHistory.filter(r => r.status === 'sakit').length;
         const totalAlpha = siswaHistory.filter(r => r.status === 'alpha').length;
         const totalDipulangkan = siswaHistory.filter(r => r.status === 'dipulangkan').length;
         const totalTerlambat = keterlambatanData?.terlambat_total || 0;

         const totalPoin = (totalTerlambat * poinSettings.late) + (totalDipulangkan * poinSettings.dipulangkan);
         detailTotalPoinSpan.textContent = totalPoin;

         detailNamaSiswaSpan.textContent = siswa.nama;
         detailKelasSiswaSpan.textContent = siswa.kelas;
         detailNisSiswaSpan.textContent = siswa.nis;
         detailWaliKelasSiswaSpan.textContent = siswa.waliKelas;
         detailTotalTerlambatSpan.textContent = totalTerlambat;
         detailTotalIzinSpan.textContent = totalIzin;
         detailTotalSakitSpan.textContent = totalSakit;
         detailTotalAlphaSpan.textContent = totalAlpha;

         siswaDetailHistoryTableBody.innerHTML = "";
         if (siswaHistory.length === 0) {
             siswaDetailHistoryTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Tidak ada riwayat absensi.</td></tr>';
         } else {
             siswaHistory.forEach(rec => {
                 const tr = document.createElement('tr');
                 let poinRecord = 0;
                 if (rec.status === 'late') {
                     poinRecord = poinSettings.late;
                 } else if (rec.status === 'dipulangkan') {
                     poinRecord = poinSettings.dipulangkan;
                 }
                 tr.innerHTML = `
                     <td>${rec.tanggal}</td>
                     <td>${capitalizeFirstLetter(rec.status)} ${rec.statusDetail ? '('+rec.statusDetail.replace('_',' ')+')' : ''}</td>
                     <td>${rec.status === 'late' ? (rec.waktu || '-') : '-'}</td>
                     <td>${rec.alasan || "-"}</td>
                     <td>${rec.pengisi || "-"}</td>
                     <td style="text-align: center;">${poinRecord}</td>
                 `;
                 siswaDetailHistoryTableBody.appendChild(tr);
             });
         }
         siswaDetailModal.style.display = 'flex';
     }

     function closeSiswaDetailModal() {
         siswaDetailModal.style.display = 'none';
         currentSiswaDetail = null;
     }
     siswaDetailModalClose.addEventListener('click', closeSiswaDetailModal);
     siswaDetailModalCloseBtn.addEventListener('click', closeSiswaDetailModal);
     siswaDetailModal.addEventListener('click', (event) => {
        if (event.target === siswaDetailModal) closeSiswaDetailModal();
     });


    /********************************************************
     *             FIREBASE INITIALIZATION & CRUD
     ********************************************************/
     function initializeFirebase() {
        try {
            if (!firebase || !firebase.apps.length) {
                throw new Error("Firebase belum diinisialisasi dengan benar.");
            }
            db = firebase.firestore();
            console.log("Firebase Firestore reference obtained.");
            db.collection('settings').doc('connectivityTest').set({ timestamp: firebase.firestore.FieldValue.serverTimestamp() })
               .then(() => console.log("Firestore connection test successful."))
               .catch(err => console.error("Firestore connection test failed:", err));
            loadAllData();
        } catch (error) {
            console.error("Getting Firestore reference failed:", error);
            showNotification("Koneksi ke database gagal. Pastikan konfigurasi Firebase benar. Cek konsol.", "error", 10000);
        }
    }

    async function loadAllData() {
        if (!db) {
            console.error("Firestore DB not initialized!");
            showNotification("Database tidak siap.", "error");
            return;
        }
        showNotification("Memuat data awal...", "info", 2000);
        try {
            await Promise.all([
                loadCollection('historyAbsensi', (data) => { historyAbsensi = data; }),
                loadCollection('archiveAbsensi', (data) => { archiveAbsensi = data; }),
                loadCollection('petugasGuru', (data) => { petugasGuru = data; }),
                loadCollection('petugasSiswa', (data) => { petugasSiswa = data.map(item => item.nama); }),
                loadCollection('databaseSiswa', (data) => {
                    databaseSiswa = data.map(s => ({ ...s, status_akademik: s.status_akademik || 'Aktif' }));
                }),
                loadCollection('hariLibur', (data) => { hariLibur = data; }),
                loadPoinSettings(),
                loadCurrentPengisi()
            ]);
            console.log("Semua data awal dimuat.");
            showNotification("Data berhasil dimuat.", "success", 2000);
            recalcAllTop5Data();
            setupRealtimeListeners();
            initialRender();
            archiveWeeklyData();
        } catch (error) {
            console.error("Error memuat data awal:", error);
            showNotification("Gagal memuat semua data. Cek konsol.", "error", 10000);
        }
    }

    async function loadCollection(collectionName, setDataCallback) {
        try {
            const snapshot = await db.collection(collectionName).get();
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setDataCallback(data);
             console.log(`Loaded ${data.length} items from ${collectionName}`);
        } catch (err) {
             console.error(`Error loading collection ${collectionName}:`, err);
             showNotification(`Gagal memuat data ${collectionName}.`, "warning");
             setDataCallback([]);
        }
    }

    async function loadCurrentPengisi() {
         try {
            const doc = await db.collection('currentPengisi').doc('pengisi').get();
            currentPengisi = doc.exists ? doc.data().nama : "";
            console.log(`Loaded current Pengisi: ${currentPengisi || 'None'}`);
         } catch (err) {
             console.error("Error loading current pengisi:", err);
             currentPengisi = "";
         }
    }

    async function loadPoinSettings() {
        try {
            const doc = await db.collection('settings').doc('points').get();
            if (doc.exists) {
                const data = doc.data();
                poinSettings = {
                    late: data.late !== undefined ? Number(data.late) : 1,
                    dipulangkan: data.dipulangkan !== undefined ? Number(data.dipulangkan) : 5
                };
                console.log(`Loaded Poin Settings:`, poinSettings);
            } else {
                console.log("No custom point settings found, using defaults.");
                await db.collection('settings').doc('points').set(poinSettings);
            }
            poinTerlambatInput.value = poinSettings.late;
            poinDipulangkanInput.value = poinSettings.dipulangkan;
        } catch (err) {
            console.error("Error loading point settings:", err);
        }
    }

    function setupRealtimeListeners() {
        db.collection('historyAbsensi').onSnapshot(handleSnapshot('historyAbsensi', (data) => { historyAbsensi = data; }), handleSnapshotError);
        db.collection('archiveAbsensi').onSnapshot(handleSnapshot('archiveAbsensi', (data) => { archiveAbsensi = data; }), handleSnapshotError);
        db.collection('petugasGuru').onSnapshot(handleSnapshot('petugasGuru', (data) => { petugasGuru = data; renderPetugasGuruTable(); renderProfileGuru(); renderProfilePengisiToday(); }), handleSnapshotError);
        db.collection('petugasSiswa').onSnapshot(handleSnapshot('petugasSiswa', (data) => { petugasSiswa = data.map(d => d.nama); renderProfileSiswa(); renderSettingsSiswaList(); }), handleSnapshotError);
        db.collection('databaseSiswa').onSnapshot(handleSnapshot('databaseSiswa', (data) => {
            databaseSiswa = data.map(s => ({ ...s, status_akademik: s.status_akademik || 'Aktif' }));
            renderDataSiswaTable();
            renderDataSiswaList();
            populateClassFilters();
            populateBulkSiswaList();
        }), handleSnapshotError);
        db.collection('currentPengisi').doc('pengisi').onSnapshot(doc => {
            currentPengisi = doc.exists ? doc.data().nama : "";
            console.log("Current Pengisi updated:", currentPengisi || 'None');
            renderProfilePengisiToday();
        }, handleSnapshotError);
         db.collection('hariLibur').onSnapshot(handleSnapshot('hariLibur', (data) => { hariLibur = data; renderHariLiburTable(); checkDateInputHoliday(tanggalAbsenInput, holidayWarning); checkDateInputHoliday(bulkTanggalAbsenInput, bulkHolidayWarning); }), handleSnapshotError);
         db.collection('settings').doc('points').onSnapshot(doc => {
            if (doc.exists) {
                const data = doc.data();
                poinSettings = {
                    late: data.late !== undefined ? Number(data.late) : 1,
                    dipulangkan: data.dipulangkan !== undefined ? Number(data.dipulangkan) : 5
                };
                poinTerlambatInput.value = poinSettings.late;
                poinDipulangkanInput.value = poinSettings.dipulangkan;
                console.log("Poin settings updated in real-time:", poinSettings);
            }
        }, handleSnapshotError);
    }

    function handleSnapshot(collectionName, setDataCallback) {
        return (snapshot) => {
            const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setDataCallback(data);
            console.log(`Realtime update for ${collectionName}: ${data.length} items`);

             const needsRecalc = ['historyAbsensi', 'archiveAbsensi', 'databaseSiswa'];
             if (needsRecalc.includes(collectionName)) {
                 recalcAllTop5Data();
             }
             const activeSubScreen = document.querySelector('.sub-screen.active');
             if (activeSubScreen) {
                 triggerRenderForSubScreen(activeSubScreen.id);
             }
             if (currentScreen === 'homeScreen') {
                 renderHome();
             }
        };
    }

    function handleSnapshotError(error) {
        console.error("Firestore listener error:", error);
        showNotification("Kesalahan update data real-time.", "error");
    }

    function initialRender() {
        renderDataSiswaList();
        populateClassFilters();
        populateBulkSiswaList();
        renderPetugasGuruTable();
        renderSettingsSiswaList();
        renderHariLiburTable();
        renderProfileGuru();
        renderProfileSiswa();
        renderProfilePengisiToday();
        updateProfileInfo();
        renderDataSiswaTable();
        renderDataKeterlambatanTable();
        renderHistoryTable();
        renderHome();
        setInitialTheme();
    }

     async function addData(collectionName, data, successMessage, buttonElement = null) {
        let originalButtonText = '';
        if (buttonElement) {
            originalButtonText = buttonElement.innerHTML;
            buttonElement.disabled = true;
            buttonElement.innerHTML = 'Menyimpan... <span class="spinner"></span>';
        }
        try {
            const docRef = await db.collection(collectionName).add(data);
            showNotification(successMessage || `Data berhasil ditambahkan.`, 'success');
            return docRef;
        } catch (error) {
            console.error(`Error adding data to ${collectionName}:`, error);
            showNotification(`Gagal menambahkan data. Cek konsol.`, 'error');
            throw error;
        } finally {
            if (buttonElement) {
                buttonElement.disabled = false;
                buttonElement.innerHTML = originalButtonText;
            }
        }
    }

    async function updateData(collectionName, docId, data, successMessage, buttonElement = null) {
        let originalButtonText = '';
        if (buttonElement) {
            originalButtonText = buttonElement.innerHTML;
            buttonElement.disabled = true;
            buttonElement.innerHTML = 'Memperbarui... <span class="spinner"></span>';
        }
        try {
            await db.collection(collectionName).doc(docId).update(data);
            showNotification(successMessage || `Data berhasil diperbarui.`, 'success');
        } catch (error) {
            console.error(`Error updating data in ${collectionName} (ID: ${docId}):`, error);
            showNotification(`Gagal memperbarui data. Cek konsol.`, 'error');
            throw error;
        } finally {
            if (buttonElement) {
                buttonElement.disabled = false;
                buttonElement.innerHTML = originalButtonText;
            }
        }
    }

    async function deleteData(collectionName, docId, successMessage) {
        try {
            await db.collection(collectionName).doc(docId).delete();
            showNotification(successMessage || `Data berhasil dihapus.`, 'success');
        } catch (error) {
            console.error(`Error deleting data from ${collectionName} (ID: ${docId}):`, error);
            showNotification(`Gagal menghapus data. Cek konsol.`, 'error');
            throw error;
        }
    }

     async function findDocuments(collectionName, field, value) {
        try {
            const snapshot = await db.collection(collectionName).where(field, '==', value).get();
            return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (error) {
            console.error(`Error finding documents in ${collectionName}:`, error);
            showNotification(`Gagal mencari data.`, 'error');
            return [];
        }
    }

     function getUniqueKelas() {
        const kelasSet = new Set(databaseSiswa.filter(s => s.status_akademik === 'Aktif').map(s => s.kelas));
        return Array.from(kelasSet).sort();
     }

     function populateClassFilters() {
         const uniqueKelas = getUniqueKelas();
         const selects = [filterKelasHistorySelect, filterKelasKeterlambatanSelect, chartFilterKelasSelect];
         selects.forEach(select => {
             if (!select) return;
             const firstOption = select.options[0];
             select.innerHTML = '';
             select.appendChild(firstOption);
             uniqueKelas.forEach(kelas => {
                 const option = document.createElement('option');
                 option.value = kelas;
                 option.textContent = kelas;
                 select.appendChild(option);
             });
         });
     }

    async function archiveWeeklyData() {
        try {
            const settingsDoc = await db.collection('settings').doc('archiveDate').get();
            const lastArchiveTimestamp = settingsDoc.exists ? settingsDoc.data().lastArchiveDate : null;
            const lastArchiveDate = lastArchiveTimestamp ? lastArchiveTimestamp.toDate() : null;
            const today = new Date();
            const oneWeek = 7 * 24 * 60 * 60 * 1000;

            if (!lastArchiveDate) {
                await db.collection('settings').doc('archiveDate').set({ lastArchiveDate: firebase.firestore.FieldValue.serverTimestamp() });
                console.log("Set initial archive date.");
                return;
            }

            if (today.getTime() - lastArchiveDate.getTime() >= oneWeek) {
                 showNotification("Memulai proses arsip data mingguan...", "info");
                 let batch = db.batch();
                 let movedCount = 0;
                 let writeCount = 0;
                 const commitBatch = async () => {
                     await batch.commit();
                     batch = db.batch();
                     writeCount = 0;
                 };
                 const startOfThisWeek = new Date(today);
                 startOfThisWeek.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1));
                 startOfThisWeek.setHours(0, 0, 0, 0);
                 const historyToArchiveSnapshot = await db.collection('historyAbsensi')
                     .where('tanggal', '<', startOfThisWeek.toISOString().split('T')[0])
                     .get();
                 historyToArchiveSnapshot.forEach(doc => {
                     const record = doc.data();
                     const archiveRef = db.collection('archiveAbsensi').doc();
                     batch.set(archiveRef, record);
                     batch.delete(doc.ref);
                     movedCount++;
                     writeCount++;
                     if (writeCount >= 490) commitBatch();
                 });
                 if (writeCount > 0) await commitBatch();
                 if (movedCount > 0) {
                     await db.collection('settings').doc('archiveDate').set({ lastArchiveDate: firebase.firestore.FieldValue.serverTimestamp() });
                     showNotification(`${movedCount} data absensi lama telah diarsipkan.`, "success");
                 } else {
                     console.log("Tidak ada data absensi lama untuk diarsipkan.");
                     await db.collection('settings').doc('archiveDate').set({ lastArchiveDate: firebase.firestore.FieldValue.serverTimestamp() });
                 }
            } else {
                 console.log("Belum saatnya arsip mingguan.");
            }
        } catch (error) {
            console.error("Error mengarsipkan data mingguan:", error);
            showNotification("Gagal melakukan arsip data mingguan.", "error");
        }
     }


    /********************************************************
     *         NAVIGATION & SCREEN MANAGEMENT (REFACTORED)
     ********************************************************/
    function showScreen(screenId) {
        screens.forEach(screen => screen.classList.remove('active'));
        const targetScreen = document.getElementById(screenId);
        if (targetScreen) {
            targetScreen.classList.add('active');
        }
        currentScreen = screenId;
        updateActiveNav(screenId);

        const firstSubScreen = targetScreen ? targetScreen.querySelector('.sub-screen') : null;
        if (firstSubScreen) {
            targetScreen.querySelectorAll('.sub-screen').forEach(s => s.classList.remove('active'));
            targetScreen.querySelectorAll('.sub-nav-item').forEach(i => i.classList.remove('active'));

            firstSubScreen.classList.add('active');
            const firstTab = targetScreen.querySelector('.sub-nav-item');
            if (firstTab) {
                firstTab.classList.add('active');
            }
            triggerRenderForSubScreen(firstSubScreen.id);
        } else if (screenId === 'homeScreen') {
            renderHome();
        }
        window.scrollTo(0, 0);
    }

    function updateActiveNav(screenId) {
        navItems.forEach(item => {
            item.classList.remove('active');
            const navId = 'nav' + screenId.charAt(0).toUpperCase() + screenId.slice(1, -6); // e.g., 'laporanScreen' -> 'navLaporan'
            if (item.id === navId) {
                item.classList.add('active');
            }
        });
    }

    function setupNavListeners() {
        document.getElementById('navHome').addEventListener('click', (e) => { e.preventDefault(); showScreen('homeScreen'); });
        document.getElementById('navAbsensi').addEventListener('click', (e) => { e.preventDefault(); showScreen('absensiScreen'); });
        document.getElementById('navLaporan').addEventListener('click', (e) => { e.preventDefault(); showScreen('laporanScreen'); });
        document.getElementById('navManajemen').addEventListener('click', (e) => { e.preventDefault(); showScreen('manajemenScreen'); });
        document.getElementById('navBantuan').addEventListener('click', (e) => { e.preventDefault(); showScreen('bantuanScreen'); });
    }

    function setupSubNavListeners() {
        const subNavs = document.querySelectorAll('.sub-nav');
        subNavs.forEach(nav => {
            nav.addEventListener('click', (e) => {
                if (e.target.classList.contains('sub-nav-item')) {
                    const targetId = e.target.dataset.target;
                    const parent = e.target.closest('.screen');

                    parent.querySelectorAll('.sub-nav-item').forEach(item => item.classList.remove('active'));
                    parent.querySelectorAll('.sub-screen').forEach(screen => screen.classList.remove('active'));

                    e.target.classList.add('active');
                    const targetSubScreen = parent.querySelector(`#${targetId}`);
                    if (targetSubScreen) {
                        targetSubScreen.classList.add('active');
                        triggerRenderForSubScreen(targetId);
                    }
                }
            });
        });
    }

    function triggerRenderForSubScreen(subScreenId) {
        switch (subScreenId) {
            case 'terlambatScreen': applyKeterlambatanFiltersAndRender(); break;
            case 'historyScreen': applyHistoryFiltersAndRender(); break;
            case 'statistikScreen':
                if (chartObj) { chartObj.destroy(); chartObj = null; }
                chartStatisticContainer.querySelector('.loader-container').style.display = 'none';
                chartStatisticCanvas.style.display = 'block';
                textAnalysisContainer.style.display = 'none';
                downloadSectionDiv.style.display = "none";
                handleChartOptionChange();
                break;
            case 'dataSiswaScreen': renderDataSiswaTable(); break;
            case 'tahunAjaranScreen': /* No specific render needed, static UI */ break;
            case 'settingsScreen': renderPetugasGuruTable(); renderSettingsSiswaList(); renderHariLiburTable(); break;
            case 'profileScreen': updateProfileInfo(); renderProfileGuru(); renderProfileSiswa(); renderProfilePengisiToday(); break;
            case 'singleAbsensiContent': break;
            case 'bulkAbsensiContent': populateBulkSiswaList(); break;
        }
    }


    /********************************************************
     *     PETUGAS GURU (Manajemen > Profile/Settings)
     ********************************************************/
      async function tambahPetugasGuruHandler(event) {
        event.preventDefault();
        const nama = guruNamaInput.value.trim();
        const hari = guruHariSelect.value;
        if (!nama || !hari) {
            showNotification("Nama & Hari piket guru tidak boleh kosong!", "warning");
            return;
        }
        if (petugasGuru.length >= 10) {
            showNotification("Maksimal 10 guru piket dapat ditambahkan.", "warning");
            return;
        }
        const dupe = petugasGuru.some(g => g.nama.toLowerCase() === nama.toLowerCase() && g.hari === hari);
        if (dupe) {
            showNotification(`Guru "${nama}" sudah terdaftar untuk hari ${hari}!`, "warning");
            return;
        }
        const guruData = { nama, hari };
        try {
            await addData('petugasGuru', guruData, `Guru "${nama}" (${hari}) berhasil ditambahkan.`, btnTambahGuru);
            formTambahGuru.reset();
        } catch (error) {}
       }
      function renderPetugasGuruTable() {
        petugasGuruTableBody.innerHTML = "";
        if (petugasGuru.length === 0) {
            petugasGuruTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Belum ada data guru piket.</td></tr>';
            return;
        }
        const sortedGuru = [...petugasGuru].sort((a, b) => {
            const dayDiff = dayOrder.indexOf(a.hari) - dayOrder.indexOf(b.hari);
            if (dayDiff !== 0) return dayDiff;
            return a.nama.localeCompare(b.nama);
        });
        sortedGuru.forEach((item) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td>${item.nama}</td>
            <td>${item.hari}</td>
            <td>
                <button class="btn btn-secondary btn-sm btn-edit-guru" data-id="${item.id}">Edit</button>
                <button class="btn btn-danger btn-sm btn-hapus-guru" data-id="${item.id}" data-nama="${item.nama}">Hapus</button>
            </td>
            `;
            petugasGuruTableBody.appendChild(tr);
        });
       }
      async function hapusPetugasGuru(guruId, guruNama) {
            showConfirmModal(`Yakin ingin menghapus guru piket "${guruNama}"?`, async () => {
                try {
                    await deleteData('petugasGuru', guruId, `Guru piket "${guruNama}" berhasil dihapus.`);
                    if (currentPengisi === guruNama) {
                        await setPengisi("");
                    }
                } catch (error) {}
            });
       }
      function openEditGuruModal(guruId) {
            const guru = petugasGuru.find(g => g.id === guruId);
            if (!guru) {
                showNotification("Data guru tidak ditemukan.", "error");
                return;
            }
            editGuruIdInput.value = guru.id;
            editGuruNamaInput.value = guru.nama;
            editGuruHariSelect.value = guru.hari;
            editGuruModal.style.display = "flex";
       }
      function closeEditGuruModal() {
            editGuruModal.style.display = "none";
            editGuruForm.reset();
       }
      async function handleEditGuruSubmit(event) {
            event.preventDefault();
            const guruId = editGuruIdInput.value;
            const nama = editGuruNamaInput.value.trim();
            const hari = editGuruHariSelect.value;
            const originalGuru = petugasGuru.find(g => g.id === guruId);
            if (!nama || !hari) {
                showNotification("Nama & Hari piket guru tidak boleh kosong!", "warning");
                return;
            }
            if (nama !== originalGuru.nama || hari !== originalGuru.hari) {
                const dupe = petugasGuru.some(g => g.nama.toLowerCase() === nama.toLowerCase() && g.hari === hari && g.id !== guruId);
                if (dupe) {
                    showNotification(`Kombinasi guru "${nama}" dan hari "${hari}" sudah ada!`, "warning");
                    return;
                }
            }
            try {
                await updateData('petugasGuru', guruId, { nama, hari }, `Data guru "${nama}" berhasil diperbarui.`, btnSimpanEditGuru);
                closeEditGuruModal();
                if (currentPengisi === originalGuru.nama && currentPengisi !== nama) {
                    await setPengisi(nama);
                } else {
                    renderProfilePengisiToday();
                }
            } catch (error) {}
       }
        petugasGuruTableBody.addEventListener('click', (event) => {
            if (event.target.classList.contains('btn-edit-guru')) {
                openEditGuruModal(event.target.dataset.id);
            }
            if (event.target.classList.contains('btn-hapus-guru')) {
                hapusPetugasGuru(event.target.dataset.id, event.target.dataset.nama);
            }
        });
        profileGuruTbody.addEventListener('click', (event) => {
            if (event.target.classList.contains('btn-edit-guru')) {
                openEditGuruModal(event.target.dataset.id);
            }
            if (event.target.classList.contains('btn-hapus-guru')) {
                hapusPetugasGuru(event.target.dataset.id, event.target.dataset.nama);
            }
        });
        editGuruForm.addEventListener('submit', handleEditGuruSubmit);
        editGuruModalClose.addEventListener('click', closeEditGuruModal);
        editGuruModalCancel.addEventListener('click', closeEditGuruModal);
        editGuruModal.addEventListener('click', (event) => {
            if (event.target === editGuruModal) {
                closeEditGuruModal();
            }
        });


    /********************************************************
     *     PETUGAS SISWA (Manajemen > Settings)
     ********************************************************/
     async function simpanPetugasSiswaHandler(event) {
         event.preventDefault();
         const s1 = siswa1Input.value.trim();
         const s2 = siswa2Input.value.trim();
         if (!s1 || !s2) {
             showNotification("Harap isi nama kedua siswa piket!", "warning");
             return;
         }
          if (s1.toLowerCase() === s2.toLowerCase()) {
             showNotification("Nama siswa piket tidak boleh sama.", "warning");
             return;
         }
         const siswa1Exists = databaseSiswa.some(s => s.nama.toLowerCase() === s1.toLowerCase() && s.status_akademik === 'Aktif');
         const siswa2Exists = databaseSiswa.some(s => s.nama.toLowerCase() === s2.toLowerCase() && s.status_akademik === 'Aktif');
         if (!siswa1Exists || !siswa2Exists) {
             let missing = [];
             if (!siswa1Exists) missing.push(s1);
             if (!siswa2Exists) missing.push(s2);
             showNotification(`Siswa aktif "${missing.join('" dan "')}" tidak ditemukan di database.`, "error", 6000);
             return;
         }
         const newPetugasSiswa = [s1, s2];
         const btn = btnSimpanPetugasSiswa;
         let originalText = btn.innerHTML;
         btn.disabled = true;
         btn.innerHTML = 'Menyimpan... <span class="spinner"></span>';
         try {
             const existingSnapshot = await db.collection('petugasSiswa').get();
             const batch = db.batch();
             existingSnapshot.forEach(doc => {
                 batch.delete(doc.ref);
             });
             await batch.commit();
             await Promise.all([
                 db.collection('petugasSiswa').add({ nama: newPetugasSiswa[0] }),
                 db.collection('petugasSiswa').add({ nama: newPetugasSiswa[1] })
             ]);
             showNotification(`Petugas siswa berhasil disimpan: ${newPetugasSiswa.join(" & ")}`, "success");
         } catch (error) {
             console.error("Error menyimpan petugas siswa:", error);
             showNotification("Gagal menyimpan petugas siswa. Cek konsol.", "error");
         } finally {
             btn.disabled = false;
             btn.innerHTML = originalText;
         }
      }
     function renderSettingsSiswaList() {
        settingsSiswaList.innerHTML = "";
         if (petugasSiswa.length === 0) {
             settingsSiswaList.innerHTML = "<li>Belum ada petugas siswa yang diatur.</li>";
         } else {
             petugasSiswa.forEach(nama => {
                 const li = document.createElement('li');
                 li.textContent = nama;
                 settingsSiswaList.appendChild(li);
             });
         }
      }

    /********************************************************
     *     MANAJEMEN SISWA (Manajemen > Data Siswa)
     ********************************************************/
    async function tambahSiswaHandler(event) {
        event.preventDefault();
        const nama = dataSiswaNamaInput.value.trim();
        const kelas = dataSiswaKelasInput.value.trim();
        const nis = dataSiswaNISInput.value.trim();
        const waliKelas = dataSiswaWaliKelasInput.value.trim();
        const waliKelasTelp = dataSiswaWaliKelasTelpInput.value.trim();
        const ortuTelp = dataSiswaOrtuTelpInput.value.trim();

        if (!nama || !kelas || !nis || !waliKelas) {
            showNotification("Field Nama, Kelas, NIS, dan Wali Kelas wajib diisi!", "warning");
            return;
        }
        const dupe = databaseSiswa.some(s => s.nama.toLowerCase() === nama.toLowerCase() || s.nis === nis);
        if (dupe) {
            showNotification("Siswa dengan Nama atau NIS tersebut sudah ada!", "warning");
            return;
        }
        const siswaData = { nama, kelas, nis, waliKelas, waliKelasTelp, ortuTelp, status_akademik: 'Aktif' }; // NEW: Add default status
        try {
            await addData('databaseSiswa', siswaData, `Siswa "${nama}" berhasil ditambahkan.`, btnTambahSiswa);
            formTambahSiswa.reset();
            searchDataSiswaTableInput.value = '';
        } catch (error) {}
     }
    function renderDataSiswaList() {
        siswaDataList.innerHTML = "";
        const sortedSiswa = [...databaseSiswa]
            .filter(s => s.status_akademik === 'Aktif')
            .sort((a, b) => a.nama.localeCompare(b.nama));
        sortedSiswa.forEach(siswa => {
            const option = document.createElement('option');
            option.value = siswa.nama;
            siswaDataList.appendChild(option);
        });
     }
    async function editSiswa(siswaId) {
        const siswa = databaseSiswa.find(s => s.id === siswaId);
        if (!siswa) {
            showNotification("Data siswa tidak ditemukan untuk diedit.", "error");
            return;
        }
        const { value: formValues } = await Swal.fire({
            title: `Edit Data ${siswa.nama}`,
            html:
                `<input id="swal-nama" class="swal2-input" value="${siswa.nama}" placeholder="Nama Siswa">` +
                `<input id="swal-kelas" class="swal2-input" value="${siswa.kelas}" placeholder="Kelas">` +
                `<input id="swal-nis" class="swal2-input" value="${siswa.nis}" placeholder="NIS">` +
                `<input id="swal-wali" class="swal2-input" value="${siswa.waliKelas}" placeholder="Wali Kelas">` +
                `<input id="swal-wali-telp" class="swal2-input" value="${siswa.waliKelasTelp || ''}" placeholder="No. Telp Wali Kelas (62...)">` +
                `<input id="swal-ortu-telp" class="swal2-input" value="${siswa.ortuTelp || ''}" placeholder="No. Telp Orang Tua (62...)">` +
                `<select id="swal-status" class="swal2-input">
                    <option value="Aktif" ${siswa.status_akademik === 'Aktif' ? 'selected' : ''}>Aktif</option>
                    <option value="Lulus" ${siswa.status_akademik === 'Lulus' ? 'selected' : ''}>Lulus</option>
                 </select>`,
            focusConfirm: false,
            preConfirm: () => {
                return {
                    nama: document.getElementById('swal-nama').value.trim(),
                    kelas: document.getElementById('swal-kelas').value.trim(),
                    nis: document.getElementById('swal-nis').value.trim(),
                    waliKelas: document.getElementById('swal-wali').value.trim(),
                    waliKelasTelp: document.getElementById('swal-wali-telp').value.trim(),
                    ortuTelp: document.getElementById('swal-ortu-telp').value.trim(),
                    status_akademik: document.getElementById('swal-status').value
                }
            }
        });

        if (formValues) {
            const { nama, kelas, nis, waliKelas, waliKelasTelp, ortuTelp, status_akademik } = formValues;
            if (!nama || !kelas || !nis || !waliKelas) {
                showNotification("Nama, Kelas, NIS, dan Wali Kelas tidak boleh kosong!", "warning");
                return;
            }
            if (nama.toLowerCase() !== siswa.nama.toLowerCase() || nis !== siswa.nis) {
                const dupe = databaseSiswa.some(s =>
                    s.id !== siswaId && (s.nama.toLowerCase() === nama.toLowerCase() || s.nis === nis)
                );
                if (dupe) {
                    showNotification("Siswa dengan Nama atau NIS baru tersebut sudah ada!", "warning");
                    return;
                }
            }
            try {
                await updateData('databaseSiswa', siswaId, {
                    nama, kelas, nis, waliKelas, waliKelasTelp, ortuTelp, status_akademik
                }, `Data siswa "${nama}" berhasil diperbarui.`);
            } catch (error) {}
        }
     }
    async function hapusSiswa(siswaId, siswaNama, siswaKelas) {
        showConfirmModal(`Yakin ingin menghapus data siswa: ${siswaNama} (${siswaKelas})? Ini juga akan menghapus riwayat absensi & keterlambatan terkait!`, async () => {
            try {
                await deleteData('databaseSiswa', siswaId, `Data siswa "${siswaNama}" dihapus.`);
                const batch = db.batch();
                const historySnapshot = await db.collection('historyAbsensi').where('nama', '==', siswaNama).get();
                historySnapshot.forEach(doc => batch.delete(doc.ref));
                const archiveSnapshot = await db.collection('archiveAbsensi').where('nama', '==', siswaNama).get();
                archiveSnapshot.forEach(doc => batch.delete(doc.ref));
                const petugasSnapshot = await db.collection('petugasSiswa').where('nama', '==', siswaNama).get();
                petugasSnapshot.forEach(doc => batch.delete(doc.ref));
                 const dipulangkanSnapshot = await db.collection('siswaDipulangkan').where('nama', '==', siswaNama).get();
                 dipulangkanSnapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                showNotification(`Riwayat terkait siswa "${siswaNama}" juga dihapus.`, "info");
                 recalcAllTop5Data();
            } catch (error) {
                showNotification(`Gagal menghapus data terkait siswa "${siswaNama}".`, "error");
            }
        });
     }
    async function hapusSemuaSiswaHandler() {
        showConfirmModal("PERINGATAN: Anda yakin ingin menghapus SEMUA data siswa, petugas siswa, riwayat absensi, dan keterlambatan? Tindakan ini tidak dapat dibatalkan!", async () => {
            showNotification("Menghapus semua data siswa...", "warning", 10000);
             const btn = btnHapusSemuaSiswa;
             const originalText = btn.innerHTML;
             btn.disabled = true;
             btnHapusPilihSiswa.disabled = true;
             btn.innerHTML = 'Menghapus... <span class="spinner"></span>';
            try {
                const collectionsToDelete = ['databaseSiswa', 'petugasSiswa', 'historyAbsensi', 'archiveAbsensi', 'siswaDipulangkan'];
                let batch = db.batch();
                let writeCount = 0;
                 const commitBatch = async () => {
                     await batch.commit();
                     batch = db.batch();
                     writeCount = 0;
                 };
                 for (const collectionName of collectionsToDelete) {
                    let snapshot;
                    do {
                        snapshot = await db.collection(collectionName).limit(500).get();
                        if (!snapshot.empty) {
                            snapshot.forEach(doc => {
                                batch.delete(doc.ref);
                                writeCount++;
                                if(writeCount >= 490) {
                                    commitBatch();
                                }
                             });
                            if(writeCount > 0) await commitBatch();
                        }
                    } while (!snapshot.empty);
                 }
                 if(writeCount > 0) await commitBatch();
                showNotification("Semua data siswa dan riwayat terkait telah dihapus!", "success");
                 recalcAllTop5Data();
                 renderHome();
            } catch (error) {
                console.error("Error menghapus semua data siswa:", error);
                showNotification("Gagal menghapus semua data siswa. Cek konsol.", "error", 10000);
            } finally {
                btn.disabled = false;
                btnHapusPilihSiswa.disabled = false;
                btn.innerHTML = originalText;
            }
        });
     }
    async function hapusPilihSiswaHandler() {
        const selectedCheckboxes = dataSiswaTableBody.querySelectorAll('.select-siswa:checked');
        if (selectedCheckboxes.length === 0) {
            showNotification("Pilih minimal satu siswa untuk dihapus.", "warning");
            return;
        }
        const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        const selectedNames = selectedIds.map(id => databaseSiswa.find(s => s.id === id)?.nama || 'ID ' + id);
        showConfirmModal(`Yakin ingin menghapus ${selectedIds.length} siswa terpilih (${selectedNames.slice(0,3).join(', ')}...)? Ini juga akan menghapus riwayat terkait!`, async () => {
             const btn = btnHapusPilihSiswa;
             const originalText = btn.innerHTML;
             btn.disabled = true;
             btnHapusSemuaSiswa.disabled = true;
             btn.innerHTML = 'Menghapus... <span class="spinner"></span>';
            try {
                const batch = db.batch();
                let namesToDelete = [];
                let writeCount = 0;
                const commitBatch = async () => {
                    await batch.commit();
                    batch = db.batch();
                    writeCount = 0;
                };
                for (const siswaId of selectedIds) {
                    const siswaRef = db.collection('databaseSiswa').doc(siswaId);
                    batch.delete(siswaRef); writeCount++;
                    const siswaData = databaseSiswa.find(s => s.id === siswaId);
                     if(siswaData) namesToDelete.push(siswaData.nama);
                     if (writeCount >= 490) await commitBatch();
                }
                 for(const nama of namesToDelete) {
                     const historySnapshot = await db.collection('historyAbsensi').where('nama', '==', nama).get();
                     historySnapshot.forEach(doc => { batch.delete(doc.ref); writeCount++; if(writeCount >= 490) commitBatch(); });
                     const archiveSnapshot = await db.collection('archiveAbsensi').where('nama', '==', nama).get();
                     archiveSnapshot.forEach(doc => { batch.delete(doc.ref); writeCount++; if(writeCount >= 490) commitBatch(); });
                     const petugasSnapshot = await db.collection('petugasSiswa').where('nama', '==', nama).get();
                     petugasSnapshot.forEach(doc => { batch.delete(doc.ref); writeCount++; if(writeCount >= 490) commitBatch(); });
                      const dipulangkanSnapshot = await db.collection('siswaDipulangkan').where('nama', '==', nama).get();
                     dipulangkanSnapshot.forEach(doc => { batch.delete(doc.ref); writeCount++; if(writeCount >= 490) commitBatch(); });
                 }
                 if (writeCount > 0) await commitBatch();
                showNotification(`${selectedIds.length} siswa dan data terkait berhasil dihapus.`, "success");
                 recalcAllTop5Data();
                 renderHome();
            } catch (error) {
                console.error("Error menghapus siswa terpilih:", error);
                showNotification("Gagal menghapus siswa terpilih. Cek konsol.", "error");
            } finally {
                btn.disabled = false;
                btnHapusSemuaSiswa.disabled = false;
                btn.innerHTML = originalText;
            }
        });
     }
    function toggleSelectAllSiswa(sourceCheckbox) {
        const checkboxes = dataSiswaTableBody.querySelectorAll('.select-siswa');
        checkboxes.forEach(cb => cb.checked = sourceCheckbox.checked);
     }
    async function importDataSiswaHandler() {
        const file = importFileSiswaInput.files[0];
        if (!file) {
            showNotification("Silakan pilih file Excel (.xlsx, .xls) terlebih dahulu.", "warning");
            return;
        }
        const btn = btnImportDataSiswa;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Mengimpor... <span class="spinner"></span>';
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                if (jsonData.length < 2) {
                    showNotification("File Excel kosong atau tidak memiliki data.", "error");
                    return;
                }
                const headers = jsonData[0].map(h => String(h).trim().toLowerCase());
                const requiredHeaders = ["nama", "kelas", "nis", "walikelas"];
                if (!requiredHeaders.every(h => headers.includes(h))) {
                    showNotification(`Format header Excel tidak sesuai. Harus ada kolom: Nama, Kelas, NIS, WaliKelas.`, "error", 7000);
                    return;
                }
                const headerIndices = {
                    nama: headers.indexOf('nama'),
                    kelas: headers.indexOf('kelas'),
                    nis: headers.indexOf('nis'),
                    waliKelas: headers.indexOf('walikelas'),
                    waliKelasTelp: headers.indexOf('walikelastelp'),
                    ortuTelp: headers.indexOf('ortutelp')
                };

                let importedCount = 0;
                let updatedCount = 0;
                let skippedCount = 0;
                let batch = db.batch();
                let batchSize = 0;
                const nisToIdMap = new Map(databaseSiswa.map(s => [s.nis, s.id]));

                const commitBatch = async () => {
                    await batch.commit();
                    batch = db.batch();
                    batchSize = 0;
                };

                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (!row || row.length === 0 || row.every(cell => !cell || String(cell).trim() === '')) {
                        continue;
                    }
                    const nis = row[headerIndices.nis]?.toString().trim();
                    const nama = row[headerIndices.nama]?.toString().trim();
                    const kelas = row[headerIndices.kelas]?.toString().trim();
                    const waliKelas = row[headerIndices.waliKelas]?.toString().trim();

                    if (!nama || !kelas || !nis || !waliKelas) {
                        skippedCount++;
                        continue;
                    }

                    const siswaData = {
                        nama, kelas, nis, waliKelas,
                        waliKelasTelp: headerIndices.waliKelasTelp > -1 ? row[headerIndices.waliKelasTelp]?.toString().trim() || "" : "",
                        ortuTelp: headerIndices.ortuTelp > -1 ? row[headerIndices.ortuTelp]?.toString().trim() || "" : ""
                    };

                    const existingSiswaId = nisToIdMap.get(nis);
                    if (existingSiswaId) {
                        const docRef = db.collection('databaseSiswa').doc(existingSiswaId);
                        batch.update(docRef, siswaData);
                        updatedCount++;
                    } else {
                        const newDocRef = db.collection('databaseSiswa').doc();
                        batch.set(newDocRef, { ...siswaData, status_akademik: 'Aktif' });
                        importedCount++;
                    }

                    batchSize++;
                    if (batchSize >= 490) {
                        await commitBatch();
                        showNotification(`Memproses ${i} dari ${jsonData.length - 1} baris...`, 'info', 1000);
                    }
                }

                if (batchSize > 0) {
                    await commitBatch();
                }

                let message = "";
                if (importedCount > 0) message += `${importedCount} siswa baru ditambahkan. `;
                if (updatedCount > 0) message += `${updatedCount} data siswa diperbarui. `;
                if (skippedCount > 0) message += `${skippedCount} baris dilewati (tidak lengkap).`;
                if (!message) message = "Tidak ada data baru untuk diimpor atau diperbarui.";

                showNotification(message, (importedCount > 0 || updatedCount > 0) ? "success" : "info", 6000);
            } catch (error) {
                console.error("Error mengimpor data siswa:", error);
                showNotification("Gagal memproses file Excel. Cek konsol.", "error", 7000);
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
                importFileSiswaInput.value = "";
                searchDataSiswaTableInput.value = '';
            }
        };
        reader.onerror = () => {
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
            importFileSiswaInput.value = "";
            showNotification("Tidak dapat membaca file.", "error");
        };
        reader.readAsArrayBuffer(file);
    }

     function renderDataSiswaTable() {
        dataSiswaTableBody.innerHTML = "";
        selectAllSiswaCheckbox.checked = false;
        const searchTerm = searchDataSiswaTableInput.value.toLowerCase();

        let dataToFilter = databaseSiswa.filter(s => s.status_akademik === currentSiswaStatusFilter);

         if (searchTerm) {
            dataToFilter = dataToFilter.filter(siswa =>
                 siswa.nama.toLowerCase().includes(searchTerm) ||
                 siswa.kelas.toLowerCase().includes(searchTerm) ||
                 siswa.nis.toLowerCase().includes(searchTerm) ||
                 siswa.waliKelas.toLowerCase().includes(searchTerm)
            );
         }
        const dataToRender = dataToFilter.sort((a,b) => sortData(a,b, siswaSort));
        updateSortIcons(dataSiswaTableBody.closest('table').querySelector('thead'), siswaSort);
        if (dataToRender.length === 0) {
             dataSiswaTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center;">${searchTerm ? 'Tidak ada siswa cocok.' : `Tidak ada siswa dengan status '${currentSiswaStatusFilter}'.`}</td></tr>`;
             return;
        }
        dataToRender.forEach((siswa) => {
            const tr = document.createElement('tr');
            tr.dataset.id = siswa.id;
            tr.innerHTML = `
            <td><input type="checkbox" class="select-siswa" value="${siswa.id}"></td>
            <td><span class="clickable-name" data-nama="${siswa.nama}" title="Lihat Detail ${siswa.nama}">${siswa.nama}</span></td>
            <td>${siswa.kelas}</td>
            <td>${siswa.nis}</td>
            <td>${siswa.waliKelas}</td>
            <td>
                <button class="btn btn-secondary btn-sm btn-edit-siswa" data-id="${siswa.id}">Ubah</button>
                <button class="btn btn-danger btn-sm btn-hapus-siswa" data-id="${siswa.id}" data-nama="${siswa.nama}" data-kelas="${siswa.kelas}">Hapus</button>
            </td>
            `;
            dataSiswaTableBody.appendChild(tr);
        });
    }

     dataSiswaTableBody.addEventListener('click', (event) => {
        if (event.target.classList.contains('btn-edit-siswa')) {
            editSiswa(event.target.dataset.id);
        } else if (event.target.classList.contains('btn-hapus-siswa')) {
            hapusSiswa(event.target.dataset.id, event.target.dataset.nama, event.target.dataset.kelas);
        } else if (event.target.classList.contains('clickable-name')) {
            showSiswaDetailModal(event.target.dataset.nama);
        }
    });
     searchDataSiswaTableInput.addEventListener('input', () => renderDataSiswaTable());
     filterStatusAkademikRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            currentSiswaStatusFilter = e.target.value;
            renderDataSiswaTable();
        });
     });


    /********************************************************
     *      MANAJEMEN TAHUN AJARAN (NEW)
     ********************************************************/
    async function prosesKenaikanKelasHandler() {
        const confirmationMessage = `
            Anda yakin ingin memproses kenaikan kelas?
            <br><br>
            <ul style="text-align: left; margin: 10px auto; max-width: 300px;">
                <li>Mengubah siswa <strong>Kelas 10 &rarr; Kelas 11</strong>.</li>
                <li>Mengubah siswa <strong>Kelas 11 &rarr; Kelas 12</strong>.</li>
                <li>Menandai siswa <strong>Kelas 12 &rarr; Lulus</strong>.</li>
            </ul>
            <strong>Tindakan ini tidak dapat dibatalkan.</strong> Data absensi lama tidak akan hilang.
        `;

        Swal.fire({
            title: 'Konfirmasi Kenaikan Kelas',
            html: confirmationMessage,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Ya, Proses Sekarang!',
            cancelButtonText: 'Batal'
        }).then(async (result) => {
            if (result.isConfirmed) {
                const btn = btnProsesKenaikanKelas;
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = 'Memproses... <span class="spinner"></span>';
                showNotification("Memulai proses kenaikan kelas...", "info", 5000);

                try {
                    const batch = db.batch();
                    let updatedCount = 0;
                    let graduatedCount = 0;

                    databaseSiswa.forEach(siswa => {
                        let newKelas = siswa.kelas;
                        let newStatus = siswa.status_akademik;
                        let hasChanged = false;

                        if (siswa.status_akademik === 'Aktif') {
                            if (siswa.kelas.includes('12')) {
                                newStatus = 'Lulus';
                                graduatedCount++;
                                hasChanged = true;
                            } else if (siswa.kelas.includes('11')) {
                                newKelas = siswa.kelas.replace('11', '12');
                                updatedCount++;
                                hasChanged = true;
                            } else if (siswa.kelas.includes('10')) {
                                newKelas = siswa.kelas.replace('10', '11');
                                updatedCount++;
                                hasChanged = true;
                            }
                        }

                        if (hasChanged) {
                            const docRef = db.collection('databaseSiswa').doc(siswa.id);
                            batch.update(docRef, { kelas: newKelas, status_akademik: newStatus });
                        }
                    });

                    await batch.commit();
                    showNotification(`Proses selesai: ${updatedCount} siswa naik kelas, ${graduatedCount} siswa diluluskan.`, "success", 8000);
                } catch (error) {
                    console.error("Error processing class promotion:", error);
                    showNotification("Gagal memproses kenaikan kelas. Cek konsol.", "error");
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }
        });
    }


    /********************************************************
     *      REKALKULASI DATA AGREGRAT (Keterlambatan & Top 5)
     ********************************************************/
    function recalcAllTop5Data() {
        const combinedHistory = [...historyAbsensi, ...archiveAbsensi];
        const counts = {
            late: {}, izin: {}, sakit: {}, alpha: {}, dipulangkan: {}
        };

        combinedHistory.forEach(record => {
            const status = record.status;
            if (counts.hasOwnProperty(status)) {
                const nameLower = record.nama.toLowerCase();
                counts[status][nameLower] = (counts[status][nameLower] || 0) + 1;
            }
        });

        dataKeterlambatan = databaseSiswa.filter(s => s.status_akademik === 'Aktif').map(siswa => ({
            nama: siswa.nama,
            kelas: siswa.kelas,
            terlambat_total: counts.late[siswa.nama.toLowerCase()] || 0
        }));

        for (const status in counts) {
            top5Data[status] = databaseSiswa.map(siswa => ({
                nama: siswa.nama,
                kelas: siswa.kelas,
                count: counts[status][siswa.nama.toLowerCase()] || 0
            }));
        }

        console.log("Data agregat (Keterlambatan & Top 5) recalculated.");

        if (document.querySelector('#terlambatScreen.active')) applyKeterlambatanFiltersAndRender();
        if (document.querySelector('#homeScreen.active')) renderTop5DashboardTable();
    }


    /********************************************************
     *            INPUT ABSENSI (Single & Bulk)
     ********************************************************/
    async function catatKehadiran(event) {
      event.preventDefault();
      const rawNama = namaSiswaInput.value.trim();
      const tanggal = tanggalAbsenInput.value;
      const statusKedatangan = statusKedatanganSelect.value;
      const waktuTerlambat = waktuTerlambatInput.value;
      const alasanUmum = dropdownAlasanSelect.value;
      const alasanCustom = alasanCustomInput.value.trim();
       const sakitDetailRadio = document.querySelector('input[name="sakitDetail"]:checked');
       const statusDetail = statusKedatangan === 'sakit' ? sakitDetailRadio?.value : null;
      if (!rawNama || !tanggal || !statusKedatangan) {
        showNotification("Mohon lengkapi Nama Siswa, Tanggal, dan Status Kedatangan.", "warning"); return;
      }
       if (!isValidInputDate(tanggal)) return;
       const siswa = databaseSiswa.find(s => s.nama.toLowerCase() === rawNama.toLowerCase() && s.status_akademik === 'Aktif');
      if (!siswa) {
        showNotification(`Siswa aktif "${rawNama}" tidak ditemukan di database.`, "error"); return;
      }
      const combinedHistory = [...historyAbsensi, ...archiveAbsensi];
      const existingRecord = combinedHistory.find(rec => rec.nama.toLowerCase() === rawNama.toLowerCase() && rec.tanggal === tanggal);
      if (existingRecord) {
        showNotification(`Siswa "${rawNama}" sudah tercatat absensinya pada tanggal ${tanggal} (${existingRecord.status}).`, "warning"); return;
      }
      let finalAlasan = "-";
      const needsReason = ["late", "izin", "sakit"];
      if (needsReason.includes(statusKedatangan)) {
          if (alasanUmum === "Lainnya" && alasanCustom) finalAlasan = alasanCustom;
          else if (alasanUmum && alasanUmum !== "Lainnya") finalAlasan = alasanUmum + (alasanCustom ? ` (${alasanCustom})` : "");
          else if (alasanCustom) finalAlasan = alasanCustom;
          else if (statusKedatangan === 'late' || statusKedatangan === 'sakit') {
               showNotification(`Mohon pilih/isi alasan untuk status ${capitalizeFirstLetter(statusKedatangan)}.`, "warning"); return;
          }
      } else if (statusKedatangan === 'dipulangkan') {
            if (alasanUmum === "Lainnya" && alasanCustom) finalAlasan = alasanCustom;
             else if (alasanUmum && alasanUmum !== "Lainnya") finalAlasan = alasanUmum + (alasanCustom ? ` (${alasanCustom})` : "");
             else if (alasanCustom) finalAlasan = alasanCustom;
      }
      const record = {
        nama: siswa.nama,
        kelas: siswa.kelas,
        tanggal,
        status: statusKedatangan,
        alasan: finalAlasan,
        pengisi: currentPengisi || "Sistem"
      };
       if (statusKedatangan === 'late' && waktuTerlambat) record.waktu = waktuTerlambat;
       if (statusKedatangan === 'sakit' && statusDetail) record.statusDetail = statusDetail;
      try {
        await addData('historyAbsensi', record, `Absensi "${siswa.nama}" (${statusKedatangan}) berhasil dicatat.`, btnCatatAbsensi);
        absensiForm.reset();
        tanggalAbsenInput.valueAsDate = new Date();
        toggleAbsensiFieldsVisibility();
        if (statusKedatangan === "late") await checkLateThreshold(siswa.nama);
      } catch (error) { }
    }

    async function checkLateThreshold(studentName) {
        const nameLower = studentName.toLowerCase();
        const currentLateCount = (dataKeterlambatan.find(s => s.nama.toLowerCase() === nameLower)?.terlambat_total || 0);
        console.log(`Checking late threshold for ${studentName}, new total count: ${currentLateCount}`);

        if (currentLateCount > 0 && currentLateCount % lateThreshold === 0) {
            const todayStr = new Date().toISOString().slice(0, 10);
            const existingDipulangkanRecords = await findDocuments('siswaDipulangkan', 'nama', studentName);
            const alreadyMarkedTodayForThisCount = existingDipulangkanRecords.some(
                doc => doc.datePulang === todayStr && doc.totalLateSaatItu === currentLateCount
            );
            if (alreadyMarkedTodayForThisCount) {
                console.log(`${studentName} already marked as 'dipulangkan' today for reaching ${currentLateCount} lates.`);
                return;
            }

            const siswaData = databaseSiswa.find(s => s.nama.toLowerCase() === nameLower);
            const waliTelp = siswaData?.waliKelasTelp;
            const ortuTelp = siswaData?.ortuTelp;

            let footerHtml = '<div style="margin-top: 15px; border-top: 1px solid #ddd; padding-top: 15px;">';
            const waliMsg = encodeURIComponent(`Yth. Bapak/Ibu ${siswaData?.waliKelas}, kami informasikan bahwa siswa an. ${studentName} (${siswaData?.kelas}) telah mencapai ${currentLateCount} kali keterlambatan. Mohon tindak lanjutnya. Terima kasih.`);
            const ortuMsg = encodeURIComponent(`Yth. Bapak/Ibu Orang Tua/Wali dari ${studentName}, kami informasikan bahwa ananda telah terlambat sebanyak ${currentLateCount} kali. Mohon perhatian dan kerjasamanya. Terima kasih.`);

            if (waliTelp) {
                footerHtml += `<a href="https://wa.me/${waliTelp}?text=${waliMsg}" target="_blank" class="btn btn-success" style="text-decoration: none;"><i class="fab fa-whatsapp"></i> Hubungi Wali Kelas</a>`;
            } else {
                footerHtml += `<a class="btn btn-secondary disabled" title="No. Telp Wali Kelas tidak ada di data siswa"><i class="fab fa-whatsapp"></i> Hubungi Wali Kelas</a>`;
            }
            if (ortuTelp) {
                footerHtml += `<a href="https://wa.me/${ortuTelp}?text=${ortuMsg}" target="_blank" class="btn btn-warning" style="text-decoration: none;"><i class="fab fa-whatsapp"></i> Hubungi Orang Tua</a>`;
            } else {
                footerHtml += `<a class="btn btn-secondary disabled" title="No. Telp Orang Tua tidak ada di data siswa"><i class="fab fa-whatsapp"></i> Hubungi Orang Tua</a>`;
            }
            footerHtml += '</div>';

            Swal.fire({
                icon: 'warning',
                title: 'Peringatan Keterlambatan!',
                html: `Siswa <strong>${studentName}</strong> telah mencapai <strong>${currentLateCount}</strong> kali keterlambatan (kelipatan ${lateThreshold}).<br><br>Siswa disarankan untuk dipulangkan dan memerlukan tindak lanjut.`,
                confirmButtonText: 'OK',
                footer: footerHtml
            }).then(async (result) => {
                 if (result.isConfirmed) {
                    try {
                        await addData('siswaDipulangkan', {
                            nama: studentName,
                            datePulang: todayStr,
                            totalLateSaatItu: currentLateCount,
                            reason: `Mencapai ${currentLateCount} keterlambatan (kelipatan ${lateThreshold})`
                        });

                        const combinedHistory = [...historyAbsensi, ...archiveAbsensi];
                        const alreadyDipulangkan = combinedHistory.some(rec => rec.nama.toLowerCase() === nameLower && rec.tanggal === todayStr && rec.status === 'dipulangkan');

                        if (!alreadyDipulangkan) {
                            const dipulangkanRecord = {
                                nama: siswaData.nama,
                                kelas: siswaData.kelas,
                                tanggal: todayStr,
                                status: 'dipulangkan',
                                alasan: `Otomatis: Mencapai ${currentLateCount} kali keterlambatan`,
                                pengisi: "Sistem"
                            };
                            await addData('historyAbsensi', dipulangkanRecord, `Status 'Dipulangkan' otomatis ditambahkan untuk ${studentName}.`);
                        } else {
                            console.log(`${studentName} sudah memiliki status 'Dipulangkan' hari ini.`);
                        }

                    } catch (error) {
                        console.error(`Failed to process post-threshold actions for ${studentName}:`, error);
                    }
                 }
            });
        }
     }

    function populateBulkSiswaList(searchTerm = '') {
        bulkAbsensiSiswaListDiv.innerHTML = '';
        const lowerSearchTerm = searchTerm.toLowerCase();
        const filteredSiswa = databaseSiswa
            .filter(s => s.status_akademik === 'Aktif' && (s.nama.toLowerCase().includes(lowerSearchTerm) || s.kelas.toLowerCase().includes(lowerSearchTerm)))
            .sort((a, b) => a.nama.localeCompare(b.nama));
        if (filteredSiswa.length === 0) {
            bulkAbsensiSiswaListDiv.innerHTML = '<p style="text-align: center; color: #888;">Tidak ada siswa aktif yang cocok.</p>';
            return;
        }
        filteredSiswa.forEach(siswa => {
            const div = document.createElement('div');
            div.innerHTML = `
                <label>
                    <input type="checkbox" name="bulkSiswa" value="${siswa.nama}" data-kelas="${siswa.kelas}">
                    ${siswa.nama} (${siswa.kelas})
                </label>
            `;
            bulkAbsensiSiswaListDiv.appendChild(div);
        });
    }
    bulkSearchSiswaInput.addEventListener('input', () => populateBulkSiswaList(bulkSearchSiswaInput.value));

    async function catatBulkAbsensiHandler(event) {
        event.preventDefault();
        const tanggal = bulkTanggalAbsenInput.value;
        const status = bulkStatusKedatanganSelect.value;
        const waktu = bulkWaktuTerlambatInput.value;
        const alasanUmum = bulkDropdownAlasanSelect.value;
        const alasanCustom = bulkAlasanCustomInput.value.trim();
        const sakitDetailRadio = document.querySelector('#bulkAbsensiForm input[name="bulkSakitDetail"]:checked');
        const statusDetail = status === 'sakit' ? sakitDetailRadio?.value : null;
        const selectedSiswaCheckboxes = bulkAbsensiSiswaListDiv.querySelectorAll('input[name="bulkSiswa"]:checked');
        if (!tanggal || !status) {
            showNotification("Mohon pilih Tanggal dan Status Kedatangan.", "warning"); return;
        }
        if (!isValidInputDate(tanggal)) return;
        if (selectedSiswaCheckboxes.length === 0) {
            showNotification("Mohon pilih minimal satu siswa.", "warning"); return;
        }
        let finalAlasan = "-";
        const needsReason = ["late", "izin", "sakit"];
        if (needsReason.includes(status)) {
            if (alasanUmum === "Lainnya" && alasanCustom) finalAlasan = alasanCustom;
            else if (alasanUmum && alasanUmum !== "Lainnya") finalAlasan = alasanUmum + (alasanCustom ? ` (${alasanCustom})` : "");
            else if (alasanCustom) finalAlasan = alasanCustom;
            else if (status === 'late' || status === 'sakit') {
                 showNotification(`Mohon pilih/isi alasan untuk status ${capitalizeFirstLetter(status)}.`, "warning"); return;
            }
        } else if (status === 'dipulangkan') {
             if (alasanUmum === "Lainnya" && alasanCustom) finalAlasan = alasanCustom;
             else if (alasanUmum && alasanUmum !== "Lainnya") finalAlasan = alasanUmum + (alasanCustom ? ` (${alasanCustom})` : "");
             else if (alasanCustom) finalAlasan = alasanCustom;
        }
        const batch = db.batch();
        const recordsToAdd = [];
        const skippedStudents = [];
        const combinedHistory = [...historyAbsensi, ...archiveAbsensi];
        selectedSiswaCheckboxes.forEach(cb => {
            const nama = cb.value;
            const kelas = cb.dataset.kelas;
            const existing = combinedHistory.find(rec => rec.nama.toLowerCase() === nama.toLowerCase() && rec.tanggal === tanggal);
            if (existing) {
                skippedStudents.push(`${nama} (sudah ada: ${existing.status})`);
            } else {
                const record = {
                    nama: nama,
                    kelas: kelas,
                    tanggal: tanggal,
                    status: status,
                    alasan: finalAlasan,
                    pengisi: currentPengisi || "Sistem (Bulk)"
                };
                 if (status === 'late' && waktu) record.waktu = waktu;
                 if (status === 'sakit' && statusDetail) record.statusDetail = statusDetail;
                 const docRef = db.collection('historyAbsensi').doc();
                 batch.set(docRef, record);
                 recordsToAdd.push(nama);
            }
        });
        if (recordsToAdd.length === 0) {
            showNotification(`Tidak ada data baru untuk ditambahkan. ${skippedStudents.length > 0 ? 'Siswa berikut dilewati: ' + skippedStudents.join(', ') : ''}`, "warning");
            return;
        }
        btnCatatBulkAbsensi.disabled = true;
        btnCatatBulkAbsensi.innerHTML = 'Menyimpan... <span class="spinner"></span>';
        try {
            await batch.commit();
            let successMsg = `${recordsToAdd.length} absensi (${status}) berhasil dicatat.`;
            if (skippedStudents.length > 0) {
                successMsg += ` ${skippedStudents.length} siswa dilewati.`;
            }
            showNotification(successMsg, "success", 6000);
            bulkAbsensiForm.reset();
            bulkTanggalAbsenInput.valueAsDate = new Date();
            populateBulkSiswaList();
            toggleBulkAbsensiFieldsVisibility();
            if (status === "late") {
                for (const namaSiswa of recordsToAdd) {
                    await checkLateThreshold(namaSiswa);
                }
            }
        } catch (error) {
            console.error("Error saving bulk absensi:", error);
            showNotification("Gagal menyimpan absensi bulk. Cek konsol.", "error");
        } finally {
            btnCatatBulkAbsensi.disabled = false;
            btnCatatBulkAbsensi.innerHTML = 'Catat Absensi Bulk';
        }
    }

    function toggleAbsensiFieldsVisibility() {
        const status = statusKedatanganSelect.value;
        const alasan = dropdownAlasanSelect.value;
        waktuTerlambatContainer.style.display = (status === 'late') ? 'block' : 'none';
        sakitDetailContainer.style.display = (status === 'sakit') ? 'block' : 'none';
        const needsReason = ['late', 'izin', 'sakit', 'dipulangkan'];
        dropdownAlasanSelect.disabled = !needsReason.includes(status);
        alasanCustomContainer.style.display = (needsReason.includes(status) && alasan === 'Lainnya') ? 'block' : 'none';
        if (status !== 'late') waktuTerlambatInput.value = '';
        if (!needsReason.includes(status)) {
            dropdownAlasanSelect.value = '';
            alasanCustomInput.value = '';
            alasanCustomContainer.style.display = 'none';
        }
         if (alasan !== 'Lainnya') {
             alasanCustomInput.value = '';
         }
    }
     statusKedatanganSelect.addEventListener('change', toggleAbsensiFieldsVisibility);
     dropdownAlasanSelect.addEventListener('change', toggleAbsensiFieldsVisibility);

     function toggleBulkAbsensiFieldsVisibility() {
         const status = bulkStatusKedatanganSelect.value;
         const alasan = bulkDropdownAlasanSelect.value;
         bulkWaktuTerlambatContainer.style.display = (status === 'late') ? 'block' : 'none';
         const bulkSakitContainer = document.getElementById('bulkSakitDetailContainer');
         if(bulkSakitContainer) bulkSakitContainer.style.display = (status === 'sakit') ? 'block' : 'none';
         const needsReason = ['late', 'izin', 'sakit', 'dipulangkan'];
         bulkDropdownAlasanSelect.disabled = !needsReason.includes(status);
         bulkAlasanCustomContainer.style.display = (needsReason.includes(status) && alasan === 'Lainnya') ? 'block' : 'none';
         if (status !== 'late') bulkWaktuTerlambatInput.value = '';
         if (!needsReason.includes(status)) {
            bulkDropdownAlasanSelect.value = '';
            bulkAlasanCustomInput.value = '';
            bulkAlasanCustomContainer.style.display = 'none';
         }
         if (alasan !== 'Lainnya') {
             bulkAlasanCustomInput.value = '';
         }
     }
      bulkStatusKedatanganSelect.addEventListener('change', toggleBulkAbsensiFieldsVisibility);
      bulkDropdownAlasanSelect.addEventListener('change', toggleBulkAbsensiFieldsVisibility);

    function isHoliday(dateString) {
        return hariLibur.some(libur => libur.tanggal === dateString);
    }
    function isValidInputDate(dateString) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
         if (!dateString || !isValidDate(dateString)) {
             showNotification("Format tanggal tidak valid (YYYY-MM-DD).", "warning");
             return false;
         }
         const inputDate = new Date(dateString);
         inputDate.setMinutes(inputDate.getMinutes() + inputDate.getTimezoneOffset());
         inputDate.setHours(0, 0, 0, 0);
        if (inputDate > today) {
            showNotification("Tidak dapat mencatat absensi untuk tanggal di masa depan.", "warning");
            return false;
        }
        if (isHoliday(dateString)) {
            showNotification(`Tanggal ${dateString} adalah hari libur.`, "warning");
            return false;
        }
        return true;
    }
     function checkDateInputHoliday(inputElement, warningElement) {
         if (!inputElement || !warningElement) return;
         const date = inputElement.value;
         if (date && isHoliday(date)) {
             warningElement.style.display = 'block';
         } else {
             warningElement.style.display = 'none';
         }
     }
     tanggalAbsenInput.addEventListener('change', () => checkDateInputHoliday(tanggalAbsenInput, holidayWarning));
     bulkTanggalAbsenInput.addEventListener('change', () => checkDateInputHoliday(bulkTanggalAbsenInput, bulkHolidayWarning));


    /********************************************************
     *      RENDER TABEL HISTORY (Laporan > History)
     ********************************************************/
     function renderHistoryTable(dataToRender = null) {
        historyTableBody.innerHTML = "";
        updateSortIcons(historyTableBody.closest('table').querySelector('thead'), historySort);
        if (dataToRender === null) {
            applyHistoryFiltersAndRender();
            return;
        }
        if (dataToRender.length === 0) {
            historyTableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">Tidak ada data riwayat yang cocok dengan filter.</td></tr>`;
            return;
        }
        const sortedData = dataToRender.sort((a, b) => sortData(a,b, historySort));
        sortedData.forEach((item) => {
            const tr = document.createElement('tr');
            const recordId = item.id;
             const isInHistory = historyAbsensi.some(r => r.id === recordId);
             const isInArchive = archiveAbsensi.some(r => r.id === recordId);
             const collectionType = isInHistory ? 'historyAbsensi' : (isInArchive ? 'archiveAbsensi' : null);
            tr.innerHTML = `
            <td>${item.tanggal}</td>
            <td><span class="clickable-name" data-nama="${item.nama}" title="Lihat Detail ${item.nama}">${item.nama}</span></td>
            <td>${item.kelas || "-"}</td>
            <td>
                <select class="status-edit-history" data-id="${recordId}" data-collection="${collectionType || ''}" ${!recordId || !collectionType ? 'disabled' : ''}>
                    <option value="late" ${item.status === "late" ? "selected" : ""}>Terlambat</option>
                    <option value="izin" ${item.status === "izin" ? "selected" : ""}>Izin</option>
                    <option value="sakit" ${item.status === "sakit" ? "selected" : ""}>Sakit</option>
                    <option value="alpha" ${item.status === "alpha" ? "selected" : ""}>Alpha</option>
                    <option value="dipulangkan" ${item.status === "dipulangkan" ? "selected" : ""}>Dipulangkan</option>
                </select>
                 ${item.statusDetail ? '<br><small>('+item.statusDetail.replace('_',' ')+')</small>' : ''}
            </td>
            <td>${item.status === 'late' ? (item.waktu || '-') : '-'}</td>
            <td>${item.alasan || "-"}</td>
            <td>${item.pengisi || "-"}</td>
            <td>
                <button class="btn btn-secondary btn-sm btn-edit-tanggal-history" data-id="${recordId}" data-collection="${collectionType || ''}" data-nama="${item.nama}" data-tanggal="${item.tanggal}" ${!recordId || !collectionType ? 'disabled' : ''}>Edit Tgl</button>
                <button class="btn btn-danger btn-sm btn-delete-history" data-id="${recordId}" data-collection="${collectionType || ''}" data-nama="${item.nama}" data-tanggal="${item.tanggal}" ${!recordId || !collectionType ? 'disabled' : ''}>Hapus</button>
            </td>
            `;
            historyTableBody.appendChild(tr);
        });
    }

    async function updateStatusHistory(recordId, collectionType, newStatus, selectElement) {
         if (!recordId || !collectionType) {
             showNotification("Tidak dapat mengubah status, ID/Sumber data tidak ditemukan.", "error");
             selectElement.value = selectElement.dataset.originalStatus || selectElement.querySelector('option[selected]')?.value;
             return;
         }
         const originalStatus = selectElement.dataset.originalStatus || selectElement.querySelector(`option[selected]`)?.value;
         selectElement.disabled = true;
         try {
             await updateData(collectionType, recordId, { status: newStatus }, "Status absensi berhasil diperbarui.");
             selectElement.dataset.originalStatus = newStatus;
             recalcAllTop5Data();
             applyKeterlambatanFiltersAndRender();
             renderHome();
         } catch (error) {
              if(originalStatus) selectElement.value = originalStatus;
         } finally {
             selectElement.disabled = false;
         }
    }
     async function editRiwayatTanggal(recordId, collectionType, currentNama, oldDate) {
         if (!recordId || !collectionType) {
             showNotification("Tidak dapat mengubah tanggal, ID/Sumber data tidak ditemukan.", "error");
             return;
         }
        const newDate = prompt(`Masukkan tanggal baru (YYYY-MM-DD) untuk absensi ${currentNama}:`, oldDate);
        if (newDate && isValidDate(newDate) && newDate !== oldDate) {
             if (!isValidInputDate(newDate)) return;
             const combinedHistory = [...historyAbsensi, ...archiveAbsensi];
             const existingOnNewDate = combinedHistory.find(rec =>
                 rec.nama.toLowerCase() === currentNama.toLowerCase() &&
                 rec.tanggal === newDate &&
                 rec.id !== recordId
             );
             if (existingOnNewDate) {
                 showNotification(`Siswa "${currentNama}" sudah memiliki data absensi pada tanggal ${newDate}.`, "warning", 6000);
                 return;
             }
            try {
                await updateData(collectionType, recordId, { tanggal: newDate }, `Tanggal absensi untuk "${currentNama}" berhasil diubah.`);
            } catch (error) {}
        } else if (newDate && !isValidDate(newDate)) {
             showNotification("Format tanggal tidak valid. Harap gunakan YYYY-MM-DD.", "warning");
        }
      }
     async function deleteRiwayat(recordId, collectionType, nama, tanggal) {
        if (!recordId || !collectionType) {
             showNotification("Tidak dapat menghapus, ID/Sumber data tidak ditemukan.", "error");
             return;
         }
         showConfirmModal(`Hapus data absensi siswa "${nama}" pada tanggal ${tanggal}?`, async () => {
             try {
                 await deleteData(collectionType, recordId, `Data absensi "${nama}" (${tanggal}) berhasil dihapus.`);
                 recalcAllTop5Data();
                 applyKeterlambatanFiltersAndRender();
                 renderHome();
             } catch (error) {}
         });
      }

     historyTableBody.addEventListener('change', (event) => {
        if (event.target.classList.contains('status-edit-history')) {
             const select = event.target;
             if (!select.dataset.originalStatus) {
                 select.dataset.originalStatus = select.value;
             }
             updateStatusHistory(select.dataset.id, select.dataset.collection, select.value, select);
         }
      });
     historyTableBody.addEventListener('click', (event) => {
        const target = event.target;
        if (target.classList.contains('btn-edit-tanggal-history')) {
            editRiwayatTanggal(target.dataset.id, target.dataset.collection, target.dataset.nama, target.dataset.tanggal);
        } else if (target.classList.contains('btn-delete-history')) {
            deleteRiwayat(target.dataset.id, target.dataset.collection, target.dataset.nama, target.dataset.tanggal);
        } else if (target.classList.contains('clickable-name')) {
            showSiswaDetailModal(target.dataset.nama);
        }
     });


    /********************************************************
     *      RENDER DATA KETERLAMBATAN (Laporan > Keterlambatan)
     ********************************************************/
     function renderDataKeterlambatanTable(dataToRender = null) {
        dataKeterlambatanTableBody.innerHTML = "";
        updateSortIcons(dataKeterlambatanTableBody.closest('table').querySelector('thead'), keterlambatanSort);
        if (dataToRender === null) {
            applyKeterlambatanFiltersAndRender();
            return;
        }
        if (dataToRender.length === 0) {
            dataKeterlambatanTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Tidak ada data keterlambatan yang cocok dengan filter.</td></tr>`;
            return;
        }
        const sortedData = dataToRender.sort((a,b) => sortData(a,b, keterlambatanSort));
        sortedData.forEach((siswa) => {
            const tr = document.createElement('tr');
            const isDisabled = siswa.terlambat_total === 0;

            const sisaModulo = siswa.terlambat_total % lateThreshold;
            const sisaKeterlambatan = sisaModulo === 0 ? lateThreshold : lateThreshold - sisaModulo;

            tr.innerHTML = `
            <td><span class="clickable-name" data-nama="${siswa.nama}" title="Lihat Detail ${siswa.nama}">${siswa.nama}</span></td>
            <td>${siswa.kelas || "-"}</td>
            <td style="text-align: center; font-weight: bold;">${siswa.terlambat_total}</td>
            <td style="text-align: center; font-weight: bold;">${sisaKeterlambatan}</td>
            <td>
                <button class="btn btn-warning btn-sm btn-reset-keterlambatan" data-nama="${siswa.nama}" ${isDisabled ? 'disabled' : ''}>Reset Jadi 0</button>
                <button class="btn btn-danger btn-sm btn-kurangi-keterlambatan" data-nama="${siswa.nama}" ${isDisabled ? 'disabled' : ''}>Kurangi 1</button>
            </td>
            `;
            dataKeterlambatanTableBody.appendChild(tr);
        });
    }

      async function resetKeterlambatanForStudent(namaSiswa) {
         showConfirmModal(`Reset jumlah keterlambatan siswa "${namaSiswa}" menjadi 0? (Riwayat lama tetap ada).`, async () => {
             try {
                 const siswa = databaseSiswa.find(s => s.nama.toLowerCase() === namaSiswa.toLowerCase());
                 if (siswa && siswa.id) {
                     await updateData('databaseSiswa', siswa.id, {
                         latenessResetDate: firebase.firestore.FieldValue.serverTimestamp()
                     }, `Keterlambatan untuk "${namaSiswa}" ditandai reset.`);
                     recalcAllTop5Data();
                     applyKeterlambatanFiltersAndRender();
                     renderHome();
                 } else {
                     showNotification(`Siswa "${namaSiswa}" tidak ditemukan di database.`, "error");
                 }
             } catch (error) {
                 showNotification(`Gagal mereset keterlambatan untuk "${namaSiswa}".`, "error");
             }
         });
       }
      async function kurangiKeterlambatan(namaSiswa) {
         showConfirmModal(`Kurangi jumlah keterlambatan siswa "${namaSiswa}" sebanyak 1? (Akan menghapus 1 record 'Terlambat' terbaru).`, async () => {
            try {
                 const combined = [...historyAbsensi, ...archiveAbsensi]
                                 .filter(rec => rec.nama.toLowerCase() === namaSiswa.toLowerCase() && rec.status === 'late')
                                 .sort((a, b) => b.tanggal.localeCompare(a.tanggal));
                 if (combined.length > 0) {
                     const latestLateRecord = combined[0];
                     const recordId = latestLateRecord.id;
                     const collectionType = historyAbsensi.some(r => r.id === recordId) ? 'historyAbsensi' : (archiveAbsensi.some(r => r.id === recordId) ? 'archiveAbsensi' : null);
                     if (recordId && collectionType) {
                         await deleteData(collectionType, recordId, `Satu record keterlambatan terbaru untuk "${namaSiswa}" (${latestLateRecord.tanggal}) dihapus.`);
                         recalcAllTop5Data();
                         applyKeterlambatanFiltersAndRender();
                         renderHome();
                     } else {
                         showNotification(`Record keterlambatan terbaru untuk "${namaSiswa}" tidak dapat dihapus.`, "error");
                     }
                 } else {
                     showNotification(`Tidak ditemukan record 'Terlambat' untuk "${namaSiswa}".`, "info");
                 }
            } catch (error) {
                showNotification(`Gagal mengurangi keterlambatan untuk "${namaSiswa}".`, "error");
            }
        });
       }
      async function resetSemuaKeterlambatanHandler() {
         showConfirmModal("PERINGATAN: Yakin ingin mereset SEMUA keterlambatan? Ini akan MENGHAPUS SEMUA record 'Terlambat' dari RIWAYAT! Tindakan ini tidak dapat dibatalkan.", async () => {
             const btn = btnResetSemuaKeterlambatan;
             const originalText = btn.innerHTML;
             btn.disabled = true;
             btn.innerHTML = 'Mereset... <span class="spinner"></span>';
            try {
                let batch = db.batch();
                 let deletedCount = 0;
                 let writeCount = 0;
                 const commitBatch = async () => {
                     await batch.commit();
                     batch = db.batch();
                     writeCount = 0;
                 };
                 const historySnapshot = await db.collection('historyAbsensi').where('status', '==', 'late').get();
                 historySnapshot.forEach(doc => {
                     batch.delete(doc.ref); deletedCount++; writeCount++;
                     if (writeCount >= 490) commitBatch();
                 });
                 const archiveSnapshot = await db.collection('archiveAbsensi').where('status', '==', 'late').get();
                 archiveSnapshot.forEach(doc => {
                     batch.delete(doc.ref); deletedCount++; writeCount++;
                     if (writeCount >= 490) commitBatch();
                 });
                 if(writeCount > 0) await commitBatch();
                 if(deletedCount > 0) {
                    showNotification(`Semua ${deletedCount} record 'Terlambat' telah dihapus.`, "success");
                 } else {
                     showNotification("Tidak ada record 'Terlambat' yang ditemukan.", "info");
                 }
                 recalcAllTop5Data();
                 applyKeterlambatanFiltersAndRender();
                 renderHome();
            } catch (error) {
                console.error("Error mereset semua keterlambatan:", error);
                showNotification("Gagal mereset semua keterlambatan. Cek konsol.", "error");
            } finally {
                 btn.disabled = false;
                 btn.innerHTML = originalText;
            }
        });
       }

     dataKeterlambatanTableBody.addEventListener('click', (event) => {
        const target = event.target;
        if (target.classList.contains('btn-reset-keterlambatan')) {
            resetKeterlambatanForStudent(target.dataset.nama);
        } else if (target.classList.contains('btn-kurangi-keterlambatan')) {
            kurangiKeterlambatan(target.dataset.nama);
        } else if (target.classList.contains('clickable-name')) {
            showSiswaDetailModal(target.dataset.nama);
        }
     });
     btnResetSemuaKeterlambatan.addEventListener('click', resetSemuaKeterlambatanHandler);


    /********************************************************
     *      FILTERING LOGIC (History & Keterlambatan)
     ********************************************************/
     function applyHistoryFiltersAndRender() {
         currentHistoryFilters = {
             searchTerm: searchHistoryInput.value.toLowerCase(),
             kelas: filterKelasHistorySelect.value,
             tanggal: filterDateInput.value,
             startDate: filterStartDateInput.value,
             endDate: filterEndDateInput.value,
             status: filterStatusSelect.value
         };
         const combined = [...historyAbsensi, ...archiveAbsensi];
         let filtered = combined;
         let filterDescription = "Menampilkan semua riwayat";
         let filtersApplied = [];
         if (currentHistoryFilters.searchTerm) {
             filtered = filtered.filter(item =>
                 item.nama.toLowerCase().includes(currentHistoryFilters.searchTerm) ||
                 (item.kelas && item.kelas.toLowerCase().includes(currentHistoryFilters.searchTerm)) ||
                 item.alasan.toLowerCase().includes(currentHistoryFilters.searchTerm) ||
                 (item.pengisi && item.pengisi.toLowerCase().includes(currentHistoryFilters.searchTerm)) ||
                 item.tanggal.includes(currentHistoryFilters.searchTerm)
             );
             filtersApplied.push(`teks "${currentHistoryFilters.searchTerm}"`);
         }
          if (currentHistoryFilters.kelas) {
              filtered = filtered.filter(item => item.kelas === currentHistoryFilters.kelas);
               filtersApplied.push(`kelas ${currentHistoryFilters.kelas}`);
          }
          if (currentHistoryFilters.tanggal) {
               filtered = filtered.filter(item => item.tanggal === currentHistoryFilters.tanggal);
               filtersApplied.push(`tanggal ${currentHistoryFilters.tanggal}`);
          } else if (currentHistoryFilters.startDate && currentHistoryFilters.endDate) {
              if (currentHistoryFilters.startDate > currentHistoryFilters.endDate) {
                  showNotification("Tanggal mulai filter tidak boleh > tanggal akhir.", "warning");
              } else {
                  filtered = filtered.filter(item => item.tanggal >= currentHistoryFilters.startDate && item.tanggal <= currentHistoryFilters.endDate);
                   filtersApplied.push(`rentang ${currentHistoryFilters.startDate} - ${currentHistoryFilters.endDate}`);
              }
          }
          if (currentHistoryFilters.status) {
              filtered = filtered.filter(item => item.status === currentHistoryFilters.status);
              filtersApplied.push(`status ${capitalizeFirstLetter(currentHistoryFilters.status)}`);
          }
         if (filtersApplied.length > 0) {
             filterDescription = `Hasil filter untuk: ${filtersApplied.join(', ')}`;
         }
         displayFilterResult(filterResultDiv, filterDescription, filtered.length);
         renderHistoryTable(filtered);
     }

     function resetHistoryFiltersHandler() {
        searchHistoryInput.value = "";
        filterKelasHistorySelect.value = "";
        filterDateInput.value = "";
        filterStartDateInput.value = "";
        filterEndDateInput.value = "";
        filterStatusSelect.value = "";
        currentHistoryFilters = {};
        filterResultDiv.style.display = "none";
        renderHistoryTable([...historyAbsensi, ...archiveAbsensi]);
        showNotification("Filter riwayat dibersihkan.", "info");
    }
     btnApplyHistoryFilter.addEventListener('click', applyHistoryFiltersAndRender);
     btnResetHistoryFilters.addEventListener('click', resetHistoryFiltersHandler);

      function applyKeterlambatanFiltersAndRender() {
         currentKeterlambatanFilters = {
             searchTerm: searchKeterlambatanInput.value.toLowerCase(),
             kelas: filterKelasKeterlambatanSelect.value,
             min: filterMinLatenessInput.value ? parseInt(filterMinLatenessInput.value) : null,
             max: filterMaxLatenessInput.value ? parseInt(filterMaxLatenessInput.value) : null,
         };
          let filtered = dataKeterlambatan;
          let filterDescription = "Menampilkan semua data keterlambatan";
          let filtersApplied = [];
          if (currentKeterlambatanFilters.searchTerm) {
              filtered = filtered.filter(siswa => siswa.nama.toLowerCase().includes(currentKeterlambatanFilters.searchTerm));
              filtersApplied.push(`nama "${currentKeterlambatanFilters.searchTerm}"`);
          }
          if (currentKeterlambatanFilters.kelas) {
              filtered = filtered.filter(siswa => siswa.kelas === currentKeterlambatanFilters.kelas);
              filtersApplied.push(`kelas ${currentKeterlambatanFilters.kelas}`);
          }
           if (currentKeterlambatanFilters.min !== null && currentKeterlambatanFilters.min >= 0) {
               filtered = filtered.filter(siswa => siswa.terlambat_total >= currentKeterlambatanFilters.min);
                filtersApplied.push(`min ${currentKeterlambatanFilters.min}`);
           }
           if (currentKeterlambatanFilters.max !== null && currentKeterlambatanFilters.max >=0) {
                if (currentKeterlambatanFilters.min !== null && currentKeterlambatanFilters.max < currentKeterlambatanFilters.min) {
                    showNotification("Filter Max tidak boleh kurang dari Min.", "warning");
                } else {
                    filtered = filtered.filter(siswa => siswa.terlambat_total <= currentKeterlambatanFilters.max);
                    filtersApplied.push(`max ${currentKeterlambatanFilters.max}`);
                }
           }
          if (filtersApplied.length > 0) {
             filterDescription = `Hasil filter untuk: ${filtersApplied.join(', ')}`;
          }
          displayFilterResult(keterlambatanFilterResultDiv, filterDescription, filtered.length);
          renderDataKeterlambatanTable(filtered);
      }

     function resetKeterlambatanFiltersHandler() {
         searchKeterlambatanInput.value = "";
         filterKelasKeterlambatanSelect.value = "";
         filterMinLatenessInput.value = "";
         filterMaxLatenessInput.value = "";
         currentKeterlambatanFilters = {};
         keterlambatanFilterResultDiv.style.display = "none";
         renderDataKeterlambatanTable(dataKeterlambatan);
         showNotification("Filter keterlambatan dibersihkan.", "info");
     }
     btnApplyKeterlambatanFilter.addEventListener('click', applyKeterlambatanFiltersAndRender);
     btnResetKeterlambatanFilter.addEventListener('click', resetKeterlambatanFiltersHandler);

     function displayFilterResult(element, description, count) {
        if (!element) return;
        element.textContent = `${description}: ${count} data ditemukan.`;
        element.style.display = count >= 0 ? "block" : "none";
     }


    /********************************************************
     *      STATISTIK (Laporan > Statistik)
     ********************************************************/
     function handleChartOptionChange() {
        const option = chartOptionSelect.value;
        const bulanRequired = ['tren_harian_telat', 'tren_kelas_telat', 'tren_hari_telat', 'status_bulanan', 'siswa_telat', 'alasan_telat'];
        const compareAvailable = ['banding_bulan'];
        const kelasFilterAvailable = ['tren_harian_telat', 'tren_kelas_telat', 'tren_hari_telat', 'status_bulanan', 'siswa_telat', 'alasan_telat'];
        statistikBulanInput.disabled = !(bulanRequired.includes(option) || compareAvailable.includes(option));
        compareMonthContainer.style.display = compareAvailable.includes(option) ? 'block' : 'none';
        chartKelasFilterContainer.style.display = kelasFilterAvailable.includes(option) ? 'block' : 'none';
         if (!compareAvailable.includes(option)) {
             statistikBulanCompareInput.value = '';
         }
          if (!kelasFilterAvailable.includes(option)) {
             chartFilterKelasSelect.value = '';
         }
     }
     chartOptionSelect.addEventListener('change', handleChartOptionChange);

    async function renderStatisticChartHandler() {
      const option = chartOptionSelect.value;
      let statistikBulan = statistikBulanInput.value;
      const compareBulan = statistikBulanCompareInput.value;
      const filterKelas = chartFilterKelasSelect.value;
      const combinedData = [...historyAbsensi, ...archiveAbsensi];
      let chartTitle = "", labels = [], datasets = [], typeChart = 'bar', showTextAnalysis = false;
       analysisContentP.innerHTML = "";
       const canvasContainer = chartStatisticContainer;
       const loader = canvasContainer.querySelector('.loader-container');
       const canvas = chartStatisticCanvas;
       if (chartObj) { chartObj.destroy(); chartObj = null; }
       canvas.style.display = 'none';
       textAnalysisContainer.style.display = 'none';
       loader.style.display = 'block';
       downloadSectionDiv.style.display = 'none';
        if (option === 'banding_bulan' && (!statistikBulan || !compareBulan)) {
             showNotification("Pilih kedua bulan untuk perbandingan.", "warning");
             loader.style.display = 'none'; return;
        }
        const needsMonthNow = ['tren_harian_telat', 'tren_kelas_telat', 'tren_hari_telat', 'status_bulanan'].includes(option);
        if (needsMonthNow && !statistikBulan) {
             if (combinedData.length > 0) {
                const latestDate = combinedData.reduce((max, item) => item.tanggal > max ? item.tanggal : max, combinedData[0].tanggal);
                statistikBulan = latestDate.slice(0,7);
                statistikBulanInput.value = statistikBulan;
                showNotification(`Bulan tidak dipilih, menampilkan data bulan terbaru: ${statistikBulan}`, 'info');
             } else {
                showNotification("Tidak ada data untuk ditampilkan.", "info");
                loader.style.display = 'none'; return;
             }
        }
        const isTotalView = (option === 'siswa_telat' || option === 'alasan_telat') && !statistikBulan;
        setTimeout(() => {
            try {
                 let filteredData = combinedData;
                 let currentMonthData = [];
                 let compareMonthData = [];
                 let bulanInfo = isTotalView ? '(Total)' : (statistikBulan ? `(${statistikBulan})` : '');
                 if (statistikBulan && option !== 'banding_bulan') {
                     currentMonthData = combinedData.filter(item => item.tanggal.startsWith(statistikBulan));
                     filteredData = currentMonthData;
                     bulanInfo = `(${statistikBulan})`;
                 } else if (option === 'banding_bulan') {
                     currentMonthData = combinedData.filter(item => item.tanggal.startsWith(statistikBulan));
                     compareMonthData = combinedData.filter(item => item.tanggal.startsWith(compareBulan));
                     filteredData = [...currentMonthData, ...compareMonthData];
                     bulanInfo = `(${statistikBulan} vs ${compareBulan})`;
                 }
                 if (filterKelas && chartKelasFilterContainer.style.display !== 'none') {
                     filteredData = filteredData.filter(item => item.kelas === filterKelas);
                     currentMonthData = currentMonthData.filter(item => item.kelas === filterKelas);
                     compareMonthData = compareMonthData.filter(item => item.kelas === filterKelas);
                     bulanInfo += (bulanInfo ? ` - ` : '') + `Kelas: ${filterKelas}`;
                 }
                if (statistikBulan && option !== 'banding_bulan') {
                     downloadSectionDiv.style.display = "block";
                 }
                switch(option) {
                    case "siswa_telat":
                        chartTitle = `Top 15 Siswa Sering Telat ${bulanInfo}`;
                        const siswaMap = {};
                        filteredData.forEach(item => {
                            if (item.status === "late") siswaMap[item.nama] = (siswaMap[item.nama] || 0) + 1;
                        });
                        const arrSiswa = Object.entries(siswaMap).map(([l, v]) => ({ label:l, value:v })).sort((a, b) => b.value - a.value).slice(0, 15);
                        labels = arrSiswa.map(x => x.label);
                        datasets = [{ label: 'Jumlah Keterlambatan', data: arrSiswa.map(x => x.value), backgroundColor: 'rgba(54, 162, 235, 0.7)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 }];
                        typeChart = 'bar';
                        break;
                    case "alasan_telat":
                        chartTitle = `Top 15 Alasan Keterlambatan ${bulanInfo}`;
                        const alasanMap = {};
                        filteredData.forEach(item => {
                            if (item.status === "late") {
                                const alasan = item.alasan || "Tidak Diketahui";
                                alasanMap[alasan] = (alasanMap[alasan] || 0) + 1;
                            }
                        });
                        const arrAlasan = Object.entries(alasanMap).map(([l, v]) => ({ label:l, value:v })).sort((a, b) => b.value - a.value).slice(0, 15);
                        labels = arrAlasan.map(x => x.label);
                        datasets = [{ label: 'Jumlah Kejadian', data: arrAlasan.map(x => x.value), backgroundColor: 'rgba(255, 159, 64, 0.7)', borderColor: 'rgba(255, 159, 64, 1)', borderWidth: 1 }];
                        typeChart = 'bar';
                         showTextAnalysis = true;
                         const totalLate = filteredData.filter(i => i.status === 'late').length;
                         let analysisHtml = `Total Keterlambatan ${bulanInfo}: ${totalLate} kali.<br>`;
                         if (arrAlasan.length > 0 && totalLate > 0) {
                            analysisHtml += `Alasan paling umum: "${arrAlasan[0].label}" (${arrAlasan[0].value} kali, ${((arrAlasan[0].value / totalLate) * 100).toFixed(1)}%).<br>`;
                         }
                          const lateWithTime = filteredData.filter(i => i.status === 'late' && i.waktu);
                          if (lateWithTime.length > 0) {
                               let totalMinutesLate = 0;
                               const schoolStartTime = "07:00";
                               lateWithTime.forEach(item => {
                                   try {
                                       const start = new Date(`1970-01-01T${schoolStartTime}:00`);
                                       const arrival = new Date(`1970-01-01T${item.waktu}:00`);
                                       if (arrival > start) {
                                           totalMinutesLate += (arrival - start) / (1000 * 60);
                                       }
                                   } catch(e) { console.warn("Error parsing time:", item.waktu); }
                               });
                               const avgMinutes = totalLate > 0 ? totalMinutesLate / lateWithTime.length : 0;
                               analysisHtml += `Rata-rata menit keterlambatan: ${avgMinutes.toFixed(1)} menit.<br>`;
                          } else if (totalLate > 0) {
                               analysisHtml += `(Data waktu kedatangan tidak tersedia).<br>`;
                          }
                         analysisContentP.innerHTML = analysisHtml;
                        break;
                    case "tren_harian_telat": {
                        if (!statistikBulan) { throw new Error("Bulan harus dipilih."); }
                        chartTitle = `Tren Keterlambatan Harian ${bulanInfo}`;
                        typeChart = 'line';
                        const latenessByDate = {};
                        const year = parseInt(statistikBulan.slice(0, 4));
                        const month = parseInt(statistikBulan.slice(5, 7));
                        const daysInMonth = new Date(year, month, 0).getDate();
                        labels = [];
                        for (let day = 1; day <= daysInMonth; day++) {
                             const dateStr = `${statistikBulan}-${day.toString().padStart(2, '0')}`;
                             if (!isHoliday(dateStr)) {
                                 labels.push(dateStr);
                                 latenessByDate[dateStr] = 0;
                             }
                         }
                        filteredData.forEach(item => {
                            if (item.status === "late" && latenessByDate[item.tanggal] !== undefined) {
                                latenessByDate[item.tanggal]++;
                            }
                        });
                         const values = labels.map(date => latenessByDate[date]);
                        datasets = [{ label: 'Jumlah Keterlambatan', data: values, backgroundColor: 'rgba(231, 76, 60, 0.2)', borderColor: 'rgba(231, 76, 60, 1)', borderWidth: 2, fill: true, tension: 0.1 }];
                        break;
                      }
                     case "tren_kelas_telat": {
                         if (!statistikBulan && !isTotalView) { throw new Error("Bulan harus dipilih."); }
                         chartTitle = `Distribusi Keterlambatan per Kelas ${bulanInfo}`;
                         typeChart = 'bar';
                         const lateByClass = {};
                         filteredData.forEach(item => {
                             if (item.status === 'late') {
                                 const kelas = item.kelas || 'Tanpa Kelas';
                                 lateByClass[kelas] = (lateByClass[kelas] || 0) + 1;
                             }
                         });
                         const sortedClasses = Object.entries(lateByClass).sort(([,a],[,b]) => b-a);
                         labels = sortedClasses.map(([kelas]) => kelas);
                         datasets = [{ label: 'Jumlah Keterlambatan', data: sortedClasses.map(([,count]) => count), backgroundColor: 'rgba(153, 102, 255, 0.7)', borderColor: 'rgba(153, 102, 255, 1)', borderWidth: 1 }];
                         break;
                      }
                     case "tren_hari_telat": {
                         if (!statistikBulan && !isTotalView) { throw new Error("Bulan harus dipilih."); }
                         chartTitle = `Distribusi Keterlambatan per Hari ${bulanInfo}`;
                         typeChart = 'bar';
                         const lateByDay = { "Senin": 0, "Selasa": 0, "Rabu": 0, "Kamis": 0, "Jumat": 0, "Sabtu": 0 };
                         filteredData.forEach(item => {
                             if (item.status === 'late') {
                                 const dayName = getDayNameFromDate(item.tanggal);
                                 if (lateByDay.hasOwnProperty(dayName)) {
                                     lateByDay[dayName]++;
                                 }
                             }
                         });
                         labels = dayOrder;
                         datasets = [{ label: 'Jumlah Keterlambatan', data: labels.map(day => lateByDay[day]), backgroundColor: 'rgba(75, 192, 192, 0.7)', borderColor: 'rgba(75, 192, 192, 1)', borderWidth: 1 }];
                         break;
                      }
                     case "status_bulanan": {
                         if (!statistikBulan) { throw new Error("Bulan harus dipilih."); }
                         chartTitle = `Distribusi Status Absensi ${bulanInfo}`;
                         typeChart = 'doughnut';
                         const statusCounts = {};
                         filteredData.forEach(item => {
                             statusCounts[item.status] = (statusCounts[item.status] || 0) + 1;
                         });
                         labels = Object.keys(statusCounts).map(s => capitalizeFirstLetter(s));
                         const statusColors = { late: '#e74c3c', izin: '#f39c12', sakit: '#3498db', alpha: '#95a5a6', dipulangkan: '#8e44ad' };
                         datasets = [{
                             label: 'Jumlah',
                             data: Object.values(statusCounts),
                             backgroundColor: Object.keys(statusCounts).map(s => statusColors[s] || '#bdc3c7')
                         }];
                         break;
                      }
                     case "banding_bulan": {
                         chartTitle = `Perbandingan Keterlambatan ${bulanInfo}`;
                         typeChart = 'bar';
                         const countCurrent = currentMonthData.filter(i => i.status === 'late').length;
                         const countCompare = compareMonthData.filter(i => i.status === 'late').length;
                         labels = [statistikBulan, compareBulan];
                         datasets = [{ label: 'Jumlah Keterlambatan', data: [countCurrent, countCompare], backgroundColor: ['rgba(54, 162, 235, 0.7)', 'rgba(255, 99, 132, 0.7)'], borderColor: ['rgba(54, 162, 235, 1)', 'rgba(255, 99, 132, 1)'], borderWidth: 1 }];
                         break;
                      }
                    default:
                        showNotification("Pilihan grafik tidak valid.", "warning");
                        loader.style.display = 'none'; return;
                }
                 if (labels.length === 0 && (!datasets[0] || datasets[0].data.length === 0) ) {
                     showNotification(`Tidak ada data untuk ditampilkan pada grafik ${option} ${bulanInfo}.`, 'info');
                      loader.style.display = 'none';
                     return;
                 }
                 const ctx = canvas.getContext('2d');
                 const chartConfig = {
                    type: typeChart,
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            ...( (typeChart === 'bar' || typeChart === 'line') && {
                                y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 }, suggestedMax: Math.max(...(datasets[0]?.data || [0]).flat(), 5) + 2 },
                                x: { ticks: { autoSkip: true, maxTicksLimit: typeChart === 'line' ? (window.innerWidth < 768 ? 10 : 15) : 20 } }
                            })
                        },
                        plugins: {
                             title: { display: true, text: chartTitle, font: { size: 16 } },
                             tooltip: { callbacks: { label: ctx => ` ${ctx.dataset.label || ''}: ${ctx.parsed?.y ?? ctx.parsed}` } },
                             legend: { display: datasets.length > 1 || typeChart === 'doughnut' || typeChart === 'pie' }
                        }
                    }
                };
                 chartObj = new Chart(ctx, chartConfig);
                 if (showTextAnalysis) textAnalysisContainer.style.display = 'block';
            } catch (err) {
                 console.error("Error rendering statistic chart:", err);
                 showNotification("Gagal membuat grafik statistik.", "error");
                 loader.innerHTML = "<p>Gagal memuat grafik.</p>";
                 loader.style.display = 'block';
                 canvas.style.display = 'none';
            } finally {
                 if (loader.innerHTML.includes('Gagal')) {}
                 else { loader.style.display = 'none'; }
                 if (chartObj) canvas.style.display = 'block';
            }
        }, 10);
    }

    async function downloadMonthlyDataHandler() {
        const month = statistikBulanInput.value;
        if (!month) {
            showNotification("Silakan pilih bulan terlebih dahulu!", "warning");
            return;
        }
        const btn = btnDownloadMonthly;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Mempersiapkan...';
        try {
            const startDate = `${month}-01`;
            const year = parseInt(month.slice(0, 4));
            const monthNum = parseInt(month.slice(5, 7));
            const lastDay = new Date(year, monthNum, 0).getDate();
            const endDate = `${month}-${lastDay.toString().padStart(2, '0')}`;
            const historySnapshot = await db.collection('historyAbsensi')
                .where('tanggal', '>=', startDate)
                .where('tanggal', '<=', endDate).get();
            const archiveSnapshot = await db.collection('archiveAbsensi')
                .where('tanggal', '>=', startDate)
                .where('tanggal', '<=', endDate).get();
            let filtered = [];
            historySnapshot.forEach(doc => filtered.push({ id: doc.id, ...doc.data() }));
            archiveSnapshot.forEach(doc => filtered.push({ id: doc.id, ...doc.data() }));
            if (filtered.length === 0) {
                showNotification(`Tidak ada data absensi untuk bulan ${month}.`, "info");
                return;
            }
            filtered.sort((a, b) => {
                const dateDiff = a.tanggal.localeCompare(b.tanggal);
                if (dateDiff !== 0) return dateDiff;
                return a.nama.localeCompare(b.nama);
            });
            const ws_data = [
                ["Tanggal", "Nama Siswa", "Kelas", "NIS", "Wali Kelas", "Status", "Waktu", "Alasan", "Pengisi"]
            ];
            for (const item of filtered) {
                const siswa = databaseSiswa.find(s => s.nama.toLowerCase() === item.nama.toLowerCase());
                ws_data.push([
                    item.tanggal,
                    item.nama,
                    item.kelas || siswa?.kelas || "-",
                    siswa?.nis || "-",
                    siswa?.waliKelas || "-",
                    capitalizeFirstLetter(item.status) + (item.statusDetail ? ` (${item.statusDetail.replace('_',' ')})` : ''),
                    item.status === 'late' ? (item.waktu || '-') : '-',
                    item.alasan || "-",
                    item.pengisi || "-"
                ]);
            }
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            ws['!cols'] = [ {wch:12}, {wch:25}, {wch:15}, {wch:15}, {wch:20}, {wch:15}, {wch:10}, {wch:35}, {wch:20} ];
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `Absensi ${month}`);
            XLSX.writeFile(wb, `Laporan_Absensi_${month}.xlsx`);
            showNotification(`File Laporan_Absensi_${month}.xlsx berhasil dibuat.`, "success");
        } catch (error) {
            console.error("Error mendownload data bulanan:", error);
            showNotification("Gagal membuat file Excel. Cek konsol.", "error");
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
     }

     function downloadChartImage() {
         const canvasToDownload = chartObj?.canvas;
         if (canvasToDownload) {
             const url = canvasToDownload.toDataURL('image/png');
             const link = document.createElement('a');
             const bulan = statistikBulanInput.value || 'total';
             const kelas = chartFilterKelasSelect.value || 'semua-kelas';
             link.download = `grafik_${chartOptionSelect.value}_${bulan}_${kelas}.png`;
             link.href = url;
             link.click();
             showNotification("Grafik sedang diunduh...", "success");
         } else {
             showNotification("Tidak ada grafik statistik untuk diunduh.", "warning");
         }
     }
     btnDownloadChart.addEventListener('click', downloadChartImage);


    /********************************************************
     *      PROFILE SCREEN FUNCTIONS (Manajemen > Profile)
     ********************************************************/
    async function updateProfileInfo() {
        profileAbsensiCountSpan.textContent = "Menghitung...";
        try {
            const totalCount = historyAbsensi.length + archiveAbsensi.length;
            profileAbsensiCountSpan.textContent = totalCount.toLocaleString('id-ID');
        } catch (error) {
            console.error("Error menghitung total absensi:", error);
            profileAbsensiCountSpan.textContent = "Error";
        }
     }
    function renderProfileGuru() {
        profileGuruTbody.innerHTML = "";
        if (petugasGuru.length === 0) {
            profileGuruTbody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Belum ada data guru piket.</td></tr>';
            return;
        }
        const sorted = [...petugasGuru].sort((a, b) => {
            const dayDiff = dayOrder.indexOf(a.hari) - dayOrder.indexOf(b.hari);
            if (dayDiff !== 0) return dayDiff;
            return a.nama.localeCompare(b.nama);
        });
        sorted.forEach((item) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td>${item.hari}</td>
            <td>${item.nama}</td>
            <td>
                <button class="btn btn-secondary btn-sm btn-edit-guru" data-id="${item.id}">Edit</button>
                <button class="btn btn-danger btn-sm btn-hapus-guru" data-id="${item.id}" data-nama="${item.nama}">Hapus</button>
            </td>
            `;
            profileGuruTbody.appendChild(tr);
        });
     }
    function renderProfileSiswa() {
        profileSiswaList.innerHTML = "";
        if (petugasSiswa.length === 0) {
            profileSiswaList.innerHTML = "<li>Belum ada petugas siswa yang diatur.</li>";
        } else {
            petugasSiswa.forEach(nama => {
                const li = document.createElement('li');
                li.textContent = nama;
                profileSiswaList.appendChild(li);
            });
        }
     }
    function renderProfilePengisiToday() {
      const dayName = getTodayDayName();
      hariAktualSpan.textContent = dayName || "(Libur/Minggu)";
      dropdownPengisiSelect.innerHTML = "";
      if (!dayName) {
        const opt = document.createElement('option');
        opt.value = "";
        opt.textContent = "(Hari ini libur)";
        opt.disabled = true;
        dropdownPengisiSelect.appendChild(opt);
        dropdownPengisiSelect.disabled = true;
         btnSetPengisi.disabled = true;
      } else {
        const todayGuru = petugasGuru.filter(g => g.hari === dayName)
                                    .sort((a,b) => a.nama.localeCompare(b.nama));
        if (todayGuru.length === 0) {
          const opt = document.createElement('option');
          opt.value = "";
          opt.textContent = `(Tidak ada guru piket ${dayName})`;
          opt.disabled = true;
          dropdownPengisiSelect.appendChild(opt);
          dropdownPengisiSelect.disabled = true;
           btnSetPengisi.disabled = true;
        } else {
           const defaultOpt = document.createElement('option');
           defaultOpt.value = "";
           defaultOpt.textContent = "-- Pilih Guru Pengisi --";
           dropdownPengisiSelect.appendChild(defaultOpt);
          todayGuru.forEach(g => {
            const opt = document.createElement('option');
            opt.value = g.nama;
            opt.textContent = g.nama;
            dropdownPengisiSelect.appendChild(opt);
          });
          dropdownPengisiSelect.disabled = false;
           btnSetPengisi.disabled = false;
            if (currentPengisi && todayGuru.some(g => g.nama === currentPengisi)) {
                dropdownPengisiSelect.value = currentPengisi;
            }
        }
      }
      currentPengisiSpan.textContent = currentPengisi || "(Belum diatur)";
      currentPengisiSpan.style.color = currentPengisi ? 'var(--success-color)' : 'var(--danger-color)';
    }
    async function setPengisiHandler() {
      const selectedGuru = dropdownPengisiSelect.value;
      if (!selectedGuru && dropdownPengisiSelect.options.length > 1 && dropdownPengisiSelect.options[0].value === "") {
          showNotification("Harap pilih guru pengisi.", "warning");
          return;
      }
       const btn = btnSetPengisi;
       const originalText = btn.innerHTML;
       btn.disabled = true;
       dropdownPengisiSelect.disabled = true;
       btn.innerHTML = 'Menyimpan...';
      try {
        await db.collection('currentPengisi').doc('pengisi').set({ nama: selectedGuru });
        showNotification(`Pengisi absensi saat ini diatur ke: ${selectedGuru || '(Tidak ada)'}`, "success");
      } catch (error) {
        console.error("Error menyimpan pengisi:", error);
        showNotification("Gagal menyimpan pengisi. Cek konsol.", "error");
      } finally {
           btn.disabled = false;
           dropdownPengisiSelect.disabled = (dropdownPengisiSelect.options.length <= 1 && !dropdownPengisiSelect.options[0]?.value);
           btn.innerHTML = originalText;
      }
    }
    function getTodayDayName() {
      const d = new Date();
      const dayNum = d.getDay();
      if (dayNum === 0) return "";
      return dayOrder[dayNum - 1] || "";
    }


    /********************************************************
     *                 HOME SCREEN FUNCTIONS
     ********************************************************/
    async function renderHome() {
      renderLatenessLineChart();
      renderTop5DashboardTable();
    }

    function renderLatenessLineChart() {
        const canvas = chartLatenessLineCanvas;
        const container = chartLatenessLineContainer;
        const loader = container.querySelector('.loader-container');
        const combinedData = [...historyAbsensi, ...archiveAbsensi];

        if (latenessLineChart) {
            latenessLineChart.destroy();
            latenessLineChart = null;
        }

        canvas.style.display = 'none';
        loader.style.display = 'block';
        loader.innerHTML = '<div class="loader"></div>';

        try {
            if (combinedData.length === 0) {
                loader.innerHTML = "<p>Belum ada data keterlambatan.</p>";
                return;
            }
            const latestDate = combinedData.reduce((max, item) => item.tanggal > max ? item.tanggal : max, combinedData[0].tanggal);
            const latestMonth = latestDate.slice(0, 7);
            const monthlyData = combinedData.filter(item => item.tanggal.startsWith(latestMonth) && item.status === "late");
            const latenessByDate = {};
            const year = parseInt(latestMonth.slice(0, 4));
            const month = parseInt(latestMonth.slice(5, 7));
            const daysInMonth = new Date(year, month, 0).getDate();
            const dates = [];
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${latestMonth}-${day.toString().padStart(2, '0')}`;
                if (!isHoliday(dateStr)) {
                    dates.push(dateStr);
                    latenessByDate[dateStr] = 0;
                }
            }
            monthlyData.forEach(item => {
                if (latenessByDate[item.tanggal] !== undefined) {
                    latenessByDate[item.tanggal]++;
                }
            });
            const counts = dates.map(date => latenessByDate[date]);
            if (dates.length === 0 || counts.every(c => c === 0)) {
                loader.innerHTML = `<p>Tidak ada data keterlambatan untuk bulan ${latestMonth}.</p>`;
                return;
            }
            const ctx = canvas.getContext('2d');
            latenessLineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: `Jumlah Keterlambatan Harian (${latestMonth})`,
                        data: counts,
                        backgroundColor: 'rgba(231, 76, 60, 0.2)',
                        borderColor: 'rgba(231, 76, 60, 1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1, precision: 0 }, suggestedMax: Math.max(...counts, 5) + 2 },
                        x: { ticks: { autoSkip: true, maxTicksLimit: (window.innerWidth < 768 ? 10 : 15) } }
                    },
                    plugins: {
                        title: { display: true, text: `Tren Keterlambatan Harian (Bulan: ${latestMonth})`, font: { size: 14 } },
                        legend: { display: false },
                        tooltip: { callbacks: { label: ctx => ` Keterlambatan: ${ctx.parsed.y}` } }
                    }
                }
            });
            loader.style.display = 'none';
            canvas.style.display = 'block';
        } catch (error) {
            console.error("Error merender grafik dashboard:", error);
            showNotification("Gagal membuat grafik tren keterlambatan.", "error");
            loader.innerHTML = "<p>Gagal memuat grafik.</p>";
        }
    }

    function renderTop5DashboardTable() {
        const category = dashboardTop5Select.value;
        const categoryText = dashboardTop5Select.options[dashboardTop5Select.selectedIndex].text;

        dashboardTop5Header.textContent = `Total ${categoryText}`;
        dashboardTop5TableBody.innerHTML = "";

        const dataForCategory = top5Data[category];

        if (!dataForCategory || dataForCategory.length === 0) {
            dashboardTop5TableBody.innerHTML = `<tr><td colspan="3" style="text-align:center;">Belum ada data.</td></tr>`;
            return;
        }

        const top5 = [...dataForCategory]
            .filter(siswa => siswa.count > 0)
            .sort((a, b) => b.count - a.count)
            .slice(0, 5);

        if (top5.length === 0) {
            dashboardTop5TableBody.innerHTML = `<tr><td colspan="3" style="text-align:center;">Tidak ada siswa dalam kategori ini.</td></tr>`;
            return;
        }

        top5.forEach((siswa, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="text-align: center; font-weight: bold;">${index + 1}</td>
                <td><span class="clickable-name" data-nama="${siswa.nama}" title="Lihat Detail ${siswa.nama}">${siswa.nama} (${siswa.kelas || '?'})</span></td>
                <td style="text-align: center; font-weight: bold;">${siswa.count}</td>
            `;
            dashboardTop5TableBody.appendChild(tr);
        });
    }
     dashboardTop5TableBody.addEventListener('click', (event) => {
        if (event.target.classList.contains('clickable-name')) {
            showSiswaDetailModal(event.target.dataset.nama);
        }
     });


     /********************************************************
      *     KELOLA HARI LIBUR & POIN (Manajemen > Settings)
      ********************************************************/
     async function tambahHariLiburHandler(event) {
         event.preventDefault();
         const tanggal = liburTanggalInput.value;
         const keterangan = liburKeteranganInput.value.trim();
         if (!tanggal || !keterangan) {
             showNotification("Tanggal dan Keterangan libur wajib diisi.", "warning"); return;
         }
          if (hariLibur.some(libur => libur.tanggal === tanggal)) {
              showNotification(`Tanggal ${tanggal} sudah ditandai sebagai hari libur.`, "warning"); return;
          }
          if (!isValidDate(tanggal)) {
                showNotification("Format tanggal tidak valid (YYYY-MM-DD).", "warning"); return;
          }
         const liburData = { tanggal, keterangan };
         try {
             await addData('hariLibur', liburData, `Hari libur ${tanggal} (${keterangan}) berhasil ditambahkan.`, btnTambahHariLibur);
             formTambahHariLibur.reset();
         } catch (error) { }
     }

     function renderHariLiburTable() {
         hariLiburTableBody.innerHTML = "";
         if (hariLibur.length === 0) {
             hariLiburTableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">Belum ada data hari libur.</td></tr>';
             return;
         }
         const sortedLibur = [...hariLibur].sort((a, b) => b.tanggal.localeCompare(a.tanggal));
         sortedLibur.forEach(libur => {
             const tr = document.createElement('tr');
             tr.innerHTML = `
                 <td>${libur.tanggal}</td>
                 <td>${libur.keterangan}</td>
                 <td>
                     <button class="btn btn-danger btn-sm btn-hapus-libur" data-id="${libur.id}" data-tanggal="${libur.tanggal}">Hapus</button>
                 </td>
             `;
             hariLiburTableBody.appendChild(tr);
         });
     }

     async function hapusHariLibur(liburId, tanggal) {
         showConfirmModal(`Yakin ingin menghapus hari libur pada tanggal ${tanggal}?`, async () => {
             try {
                 await deleteData('hariLibur', liburId, `Hari libur ${tanggal} berhasil dihapus.`);
             } catch (error) { }
         });
     }

     async function simpanPoinHandler(event) {
        event.preventDefault();
        const poinTerlambat = parseInt(poinTerlambatInput.value, 10);
        const poinDipulangkan = parseInt(poinDipulangkanInput.value, 10);

        if (isNaN(poinTerlambat) || isNaN(poinDipulangkan) || poinTerlambat < 0 || poinDipulangkan < 0) {
            showNotification("Nilai poin harus angka positif.", "warning");
            return;
        }

        const newSettings = { late: poinTerlambat, dipulangkan: poinDipulangkan };
        const btn = btnSimpanPoin;
        let originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Menyimpan... <span class="spinner"></span>';

        try {
            await db.collection('settings').doc('points').set(newSettings);
            showNotification("Pengaturan poin berhasil disimpan.", "success");
        } catch (error) {
            console.error("Error saving point settings:", error);
            showNotification("Gagal menyimpan pengaturan poin.", "error");
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

     formTambahHariLibur.addEventListener('submit', tambahHariLiburHandler);
     hariLiburTableBody.addEventListener('click', (event) => {
         if (event.target.classList.contains('btn-hapus-libur')) {
             hapusHariLibur(event.target.dataset.id, event.target.dataset.tanggal);
         }
     });

    /********************************************************
     *      FUNGSI BARU: DOWNLOAD LAPORAN SISWA
     ********************************************************/
    async function downloadSiswaReportHandler() {
        if (!currentSiswaDetail) {
            showNotification("Data siswa tidak ditemukan untuk diunduh.", "error");
            return;
        }

        const { siswa, siswaHistory } = currentSiswaDetail;
        const btn = btnDownloadSiswaReport;
        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = 'Mempersiapkan...';

        try {
            const totalTerlambat = siswaHistory.filter(r => r.status === 'late').length;
            const totalIzin = siswaHistory.filter(r => r.status === 'izin').length;
            const totalSakit = siswaHistory.filter(r => r.status === 'sakit').length;
            const totalAlpha = siswaHistory.filter(r => r.status === 'alpha').length;
            const totalDipulangkan = siswaHistory.filter(r => r.status === 'dipulangkan').length;
            const totalPoin = (totalTerlambat * poinSettings.late) + (totalDipulangkan * poinSettings.dipulangkan);

            const ws_data = [
                ["Laporan Absensi Siswa"],
                [],
                ["Nama", siswa.nama],
                ["Kelas", siswa.kelas],
                ["NIS", siswa.nis],
                ["Wali Kelas", siswa.waliKelas],
                [],
                ["Ringkasan Absensi"],
                ["Total Terlambat", totalTerlambat],
                ["Total Izin", totalIzin],
                ["Total Sakit", totalSakit],
                ["Total Alpha", totalAlpha],
                ["Total Poin Pelanggaran", totalPoin],
                [],
                [],
                ["Riwayat Absensi Lengkap"],
                ["Tanggal", "Status", "Waktu Kedatangan", "Alasan", "Pengisi", "Poin"]
            ];

            siswaHistory.forEach(rec => {
                let poinRecord = 0;
                if (rec.status === 'late') poinRecord = poinSettings.late;
                else if (rec.status === 'dipulangkan') poinRecord = poinSettings.dipulangkan;

                ws_data.push([
                    rec.tanggal,
                    capitalizeFirstLetter(rec.status) + (rec.statusDetail ? ` (${rec.statusDetail.replace('_',' ')})` : ''),
                    rec.status === 'late' ? (rec.waktu || '-') : '-',
                    rec.alasan || "-",
                    rec.pengisi || "-",
                    poinRecord
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            ws['!cols'] = [ {wch:25}, {wch:35}, {wch:20}, {wch:35}, {wch:20}, {wch:10} ];
            ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 5 } }];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `Laporan ${siswa.nama}`);
            XLSX.writeFile(wb, `Laporan_Siswa_${siswa.nama.replace(/ /g, '_')}.xlsx`);
            showNotification(`File laporan untuk ${siswa.nama} berhasil dibuat.`, "success");

        } catch (error) {
            console.error("Error membuat laporan siswa:", error);
            showNotification("Gagal membuat file Excel laporan siswa. Cek konsol.", "error");
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }


    /********************************************************
     *               UTILITY & THEME FUNCTIONS
     ********************************************************/
    function capitalizeFirstLetter(string) {
        if (!string) return "";
        return string.charAt(0).toUpperCase() + string.slice(1);
     }
    function sortData(a, b, sortState) {
        const valA = a[sortState.column];
        const valB = b[sortState.column];
        let comparison = 0;
        if (typeof valA === 'string' && typeof valB === 'string') {
            comparison = valA.localeCompare(valB, 'id-ID');
        } else if (typeof valA === 'number' && typeof valB === 'number') {
            comparison = valA - valB;
        } else {
             const strA = String(valA ?? '');
             const strB = String(valB ?? '');
             comparison = strA.localeCompare(strB, 'id-ID');
        }
        return sortState.direction === 'asc' ? comparison : (comparison * -1);
     }
    function addTableSorting(tableElement, sortState, renderFunction) {
        const headers = tableElement.querySelectorAll('th.sortable');
         headers.forEach(th => {
             th.addEventListener('click', () => {
                 const column = th.dataset.sortColumn;
                 if (sortState.column === column) {
                     sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                 } else {
                     sortState.column = column;
                     sortState.direction = 'asc';
                 }
                 renderFunction();
             });
         });
     }
    function updateSortIcons(theadElement, sortState) {
        theadElement.querySelectorAll('th.sortable .sort-icon').forEach(icon => {
            icon.textContent = '';
        });
        const activeHeader = theadElement.querySelector(`th[data-sort-column="${sortState.column}"]`);
        if (activeHeader) {
            const iconSpan = activeHeader.querySelector('.sort-icon');
            if(iconSpan) iconSpan.textContent = sortState.direction === 'asc' ? ' ▲' : ' ▼';
        }
     }
     function isValidDate(dateString) {
        const regEx = /^\d{4}-\d{2}-\d{2}$/;
        if(!dateString.match(regEx)) return false;
        const d = new Date(dateString);
         const dNum = d.getTime();
         if (!dNum && dNum !== 0) return false;
         try {
             return d.toISOString().slice(0,10) === dateString;
         } catch (e) {
             return false;
         }
    }
     function getDayNameFromDate(dateString) {
        try {
             const dateParts = dateString.split('-');
             const date = new Date(Date.UTC(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2])));
             const dayNum = date.getUTCDay();
             return dayOrder[dayNum - 1] || "";
        } catch (e) {
            console.error("Error getting day name from date:", dateString, e);
            return "";
        }
    }
     function setInitialTheme() {
         const savedTheme = localStorage.getItem('theme') || 'light';
         document.body.setAttribute('data-theme', savedTheme);
         updateThemeIcon(savedTheme);
     }
     function updateThemeIcon(theme) {
          const icon = themeToggleButton.querySelector('i');
          if (icon) {
              icon.className = `fas ${theme === 'dark' ? 'fa-sun' : 'fa-moon'}`;
          }
          themeToggleButton.title = `Ganti ke Tema ${theme === 'dark' ? 'Terang' : 'Gelap'}`;
     }
     themeToggleButton.addEventListener('click', () => {
        let currentTheme = document.body.getAttribute('data-theme');
        let newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        updateThemeIcon(newTheme);
         if (document.querySelector('#statistikScreen.active') && (chartObj || latenessLineChart)) {
              renderStatisticChartHandler();
         }
         if (currentScreen === 'homeScreen' && latenessLineChart) {
              renderLatenessLineChart();
         }
     });


    /********************************************************
     *                INITIALIZATION
     ********************************************************/
    function init() {
        notificationArea = document.getElementById('notification-area');
        if (!notificationArea) {
            console.error("CRITICAL: Notification area element not found!");
            alert("Area notifikasi tidak ditemukan! Notifikasi tidak akan muncul.");
        }

        initializeFirebase();
        setupNavListeners();
        setupSubNavListeners();

        absensiForm.addEventListener('submit', catatKehadiran);
        bulkAbsensiForm.addEventListener('submit', catatBulkAbsensiHandler);
        formTambahGuru.addEventListener('submit', tambahPetugasGuruHandler);
        formSimpanSiswaPiket.addEventListener('submit', simpanPetugasSiswaHandler);
        formTambahSiswa.addEventListener('submit', tambahSiswaHandler);
        formTambahHariLibur.addEventListener('submit', tambahHariLiburHandler);
        editGuruForm.addEventListener('submit', handleEditGuruSubmit);
        formPoinPelanggaran.addEventListener('submit', simpanPoinHandler);

        btnSetPengisi.addEventListener('click', setPengisiHandler);
        btnResetSemuaKeterlambatan.addEventListener('click', resetSemuaKeterlambatanHandler);
        btnHapusSemuaSiswa.addEventListener('click', hapusSemuaSiswaHandler);
        btnHapusPilihSiswa.addEventListener('click', hapusPilihSiswaHandler);
        btnImportDataSiswa.addEventListener('click', importDataSiswaHandler);
        btnRenderChart.addEventListener('click', renderStatisticChartHandler);
        btnDownloadMonthly.addEventListener('click', downloadMonthlyDataHandler);
        btnDownloadChart.addEventListener('click', downloadChartImage);
        btnApplyHistoryFilter.addEventListener('click', applyHistoryFiltersAndRender);
        btnResetHistoryFilters.addEventListener('click', resetHistoryFiltersHandler);
        btnApplyKeterlambatanFilter.addEventListener('click', applyKeterlambatanFiltersAndRender);
        btnResetKeterlambatanFilter.addEventListener('click', resetKeterlambatanFiltersHandler);
        btnProsesKenaikanKelas.addEventListener('click', prosesKenaikanKelasHandler);
        btnDownloadSiswaReport.addEventListener('click', downloadSiswaReportHandler);

         dashboardTop5Select.addEventListener('change', renderTop5DashboardTable);
         selectAllSiswaCheckbox.addEventListener('change', (e) => toggleSelectAllSiswa(e.target));
         statusKedatanganSelect.addEventListener('change', toggleAbsensiFieldsVisibility);
         dropdownAlasanSelect.addEventListener('change', toggleAbsensiFieldsVisibility);
         bulkStatusKedatanganSelect.addEventListener('change', toggleBulkAbsensiFieldsVisibility);
         bulkDropdownAlasanSelect.addEventListener('change', toggleBulkAbsensiFieldsVisibility);
         tanggalAbsenInput.addEventListener('change', () => checkDateInputHoliday(tanggalAbsenInput, holidayWarning));
         bulkTanggalAbsenInput.addEventListener('change', () => checkDateInputHoliday(bulkTanggalAbsenInput, bulkHolidayWarning));
         chartOptionSelect.addEventListener('change', handleChartOptionChange);

         addTableSorting(dataSiswaTableBody.closest('table'), siswaSort, () => renderDataSiswaTable());
         addTableSorting(dataKeterlambatanTableBody.closest('table'), keterlambatanSort, applyKeterlambatanFiltersAndRender);
         addTableSorting(historyTableBody.closest('table'), historySort, applyHistoryFiltersAndRender);

         searchDataSiswaTableInput.addEventListener('input', () => renderDataSiswaTable());
         searchKeterlambatanInput.addEventListener('input', applyKeterlambatanFiltersAndRender);
         searchHistoryInput.addEventListener('input', applyHistoryFiltersAndRender);

         tanggalAbsenInput.valueAsDate = new Date();
         bulkTanggalAbsenInput.valueAsDate = new Date();
         toggleAbsensiFieldsVisibility();
         toggleBulkAbsensiFieldsVisibility();
         setInitialTheme();
         handleChartOptionChange();
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
